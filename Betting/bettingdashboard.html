<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torn Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            background: #fafbfc;
            color: #232526;
            height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }
        .center-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 600px;
            padding: 20px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 16px;
            line-height: 1.2;
            color: #232526;
        }
        
        .title-text {
            color: #232526;
        }
        
        .title-highlight {
            color: #2563eb;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #6b7280;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .call-to-action {
            font-size: 1rem;
            color: #2563eb;
            font-weight: 500;
            margin-bottom: 0;
        }
        
        .info-message {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 12px;
            text-align: center;
            line-height: 1.4;
        }
        

        
        .login-form {
            width: 100%;
            max-width: 400px;
        }
        .center-box h2 {
            font-size: 1.35rem;
            font-weight: 500;
            margin-bottom: 28px;
            letter-spacing: -0.2px;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
        }
        .api-input {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .api-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1.2px solid #e3e6ea;
            border-radius: 8px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            font-size: 15px;
            background: #f6f8fa;
            color: #232526;
            transition: all 0.2s cubic-bezier(.4,0,.2,1);
        }
        .api-input input:focus {
            outline: none;
            border-color: #232526;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(35,37,38,0.08);
        }
        .api-input button {
            padding: 12px 28px;
            background: linear-gradient(90deg, #232526 0%, #414345 100%);
            color: #fff;
            border: none;
            border-radius: 22px;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(.4,0,.2,1);
            box-shadow: 0 2px 8px rgba(35,37,38,0.07);
            letter-spacing: 0.01em;
            position: relative;
        }
        .api-input button:hover, .api-input button:focus {
            background: linear-gradient(90deg, #414345 0%, #232526 100%);
            box-shadow: 0 6px 18px rgba(35,37,38,0.13);
            transform: translateY(-1px) scale(1.04);
        }
        .error-message {
            color: #e63946;
            font-size: 0.98rem;
            margin-top: 18px;
            min-height: 22px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            letter-spacing: -0.2px;
        }
        .success-message {
            color: #16a34a;
            font-size: 1.05rem;
            margin-top: 22px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            letter-spacing: -0.2px;
            text-align: center;
        }
        /* Management System Styles */
        .dashboard {
            width: 100vw;
            height: 100vh;
            background: #fafbfc;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border-bottom: 1px solid #ececec;
            padding: 0 20px;
            min-height: 60px;
            gap: 20px;
        }

        .dashboard-tabs {
            display: flex;
            gap: 0;
        }

        .dashboard-controls {
            display: flex;
            gap: 10px;
            padding-right: 20px;
        }

        .user-info-section {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            min-width: 250px;
            max-width: 350px;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .user-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.85rem;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .user-level {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            line-height: 1.1;
        }

        .user-faction {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            line-height: 1.1;
        }

        .logout-btn {
            background: #ef4444;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
        }
        .dashboard-tab {
            padding: 18px 36px;
            font-size: 1rem;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            font-weight: 500;
            color: #232526;
            background: none;
            border: none;
            border-bottom: 2.5px solid transparent;
            cursor: pointer;
            transition: all 0.18s cubic-bezier(.4,0,.2,1);
            min-height: 44px; /* Touch-friendly minimum size */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .dashboard-tab.active {
            border-bottom: 2.5px solid #232526;
            color: #232526;
            background: #f6f8fa;
        }
        .dashboard-tab:not(.active):hover {
            background: #f6f8fa;
        }
        .dashboard-content {
            flex: 1;
            padding: 40px 32px 0 32px;
            width: 100%;
            box-sizing: border-box;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .in-progress {
            text-align: center;
            color: #888;
            font-size: 1.2rem;
            margin-top: 80px;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
        }
        
        /* Colosseum Betting Platform Styles */
        .betting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .betting-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #232526;
        }

        .betting-controls {
            display: flex;
                gap: 12px;
            align-items: center;
        }

        .betting-info {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .betting-info p {
            margin: 0;
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.5;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
        }

        .betting-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .betting-filters {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
            padding: 0 4px;
        }
        
        .search-container {
            width: 100%;
        }
        
        .faction-search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: 'Inter', 'DM Sans', Arial, sans-serif;
            background: white;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }
        
        .faction-search-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .faction-search-input::placeholder {
            color: #9ca3af;
        }
        
        .filter-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 10px 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #6b7280;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
        }
        
        .filter-tab:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .filter-tab.active {
            background: #232526;
            color: white;
            border-color: #232526;
        }

        .betting-stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .betting-stat-card h3 {
            color: #6b7280;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .betting-stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #232526;
        }

        .betting-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .betting-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(35,37,38,0.08);
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .betting-card:hover {
            box-shadow: 0 8px 32px rgba(35,37,38,0.12);
            transform: translateY(-4px);
        }

        .betting-card-header {
            padding: 14px 18px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            position: relative;
        }

        .betting-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #059669, #10b981, #059669);
        }

        .betting-card-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 6px;
            letter-spacing: -0.025em;
        }

        .betting-card-subtitle {
            font-size: 0.8rem;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .betting-card-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .betting-card-status.active {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .betting-card-status.finished {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .betting-card-status.preparing {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .betting-card-content {
            padding: 16px 18px;
        }

        .betting-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .betting-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        .betting-option:hover {
            border-color: #059669;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.15);
        }

        .betting-option.selected {
            border-color: #059669;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }

        .betting-option-left {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .betting-option-name {
            font-weight: 700;
            color: #1e293b;
            font-size: 0.9rem;
            letter-spacing: -0.025em;
        }

        .betting-option-name a {
            color: #059669;
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
        }

        .betting-option-name a:hover {
            color: #047857;
            text-decoration: none;
        }

        .betting-option-name a::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: #047857;
            transition: width 0.2s ease;
        }

        .betting-option-name a:hover::after {
            width: 100%;
        }

        .betting-option-details {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
        }

        .betting-option-right {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .betting-odds {
            font-size: 1.1rem;
            font-weight: 800;
            color: #059669;
            margin-bottom: 2px;
            letter-spacing: -0.025em;
        }

        .betting-returns {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
        }

        .betting-card-footer {
            padding: 14px 18px;
            border-top: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .betting-volume {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .betting-volume::before {
            content: 'ðŸ’°';
            font-size: 1rem;
        }

        .betting-action-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.2);
            letter-spacing: 0.025em;
        }

        .betting-action-btn:hover {
            background: linear-gradient(135deg, #10b981, #059669);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
        }

        .betting-action-btn:disabled {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .betting-actions {
            display: flex;
            align-items: center;
        }

        .betting-report-link {
            padding: 8px 16px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .betting-report-link:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            text-decoration: none;
            color: white;
        }

        .betting-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .betting-modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .betting-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .betting-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #232526;
        }

        .betting-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .betting-modal-close:hover {
            background: #f3f4f6;
            color: #232526;
        }

        .betting-form-group {
            margin-bottom: 16px;
        }

        .betting-form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #232526;
            margin-bottom: 8px;
        }

        .betting-form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        .betting-form-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .betting-form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .betting-form-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .betting-form-btn-primary {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }

        .betting-form-btn-primary:hover {
            background: linear-gradient(135deg, #047857, #059669);
        }

        .betting-form-btn-secondary {
            background: #f3f4f6;
            color: #6b7280;
        }

        .betting-form-btn-secondary:hover {
            background: #e5e7eb;
        }

        .betting-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            color: #166534;
        }

        .betting-message.error {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        .betting-copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .betting-copy-btn:hover {
            background: #2563eb;
        }

        .betting-copy-btn:active {
            transform: scale(0.95);
        }

        .betting-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 6px;
            margin-top: 8px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .betting-timer.countdown {
            animation: pulse 2s infinite;
        }

        .betting-timer.duration {
            animation: subtle-glow 3s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.02);
            }
        }

        @keyframes subtle-glow {
            0%, 100% {
                box-shadow: 0 0 0 rgba(5, 150, 105, 0);
            }
            50% {
                box-shadow: 0 0 8px rgba(5, 150, 105, 0.3);
            }
        }

        .betting-timer.countdown {
            background: #fef3c7;
            color: #92400e;
        }

        .betting-timer.duration {
            background: #dcfce7;
            color: #166534;
        }

        .betting-timer.finished {
            background: #f3f4f6;
            color: #6b7280;
        }

        .betting-timer-icon {
            font-size: 1rem;
        }

        @media (max-width: 1200px) {
            .betting-grid {
            grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                height: 100vh;
                overflow-x: hidden;
            }
            
            .dashboard-header {
                flex-wrap: wrap;
                padding: 0;
            }
            
            .dashboard-tab {
                flex: 1;
                min-width: 0;
                padding: 16px 12px;
                font-size: 0.9rem;
                text-align: center;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .dashboard-content {
                padding: 20px 16px 0 16px;
                overflow-x: hidden;
            }
            
            .betting-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .betting-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .betting-controls {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .betting-filters {
                gap: 12px;
            }
            
            .faction-search-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .filter-tabs {
                gap: 6px;
            }
            
            .filter-tab {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
            
            .betting-controls .btn {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
            
            .betting-title {
                font-size: 1.3rem;
            }
            
            .betting-info {
                padding: 12px 16px;
                margin-bottom: 20px;
            }
            
            .betting-info p {
                font-size: 0.85rem;
                line-height: 1.4;
            }
            
            .betting-stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .betting-stat-card {
                padding: 12px;
            }
            
            .betting-stat-card .value {
                font-size: 1.3rem;
            }
            
            .betting-card {
                padding: 16px;
            }
            
            .betting-card-header {
                padding: 12px 16px;
            }
            
            .betting-card-title {
                font-size: 0.9rem;
            }
            
            .betting-card-content {
                padding: 14px 16px;
            }
            
            .betting-option {
                padding: 10px 12px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .betting-option-left {
                text-align: center;
            }
            
            .betting-option-right {
                text-align: center;
                align-items: center;
            }
            
            .betting-odds {
                font-size: 1rem;
            }
            
            .betting-card-footer {
                padding: 12px 16px;
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .betting-action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .betting-modal-content {
                width: 95%;
                max-width: none;
                margin: 20px;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .betting-modal-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .betting-modal-title {
                font-size: 1.1rem;
            }
            
            .betting-form-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .betting-form-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .betting-form-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-tab {
                padding: 14px 8px;
                font-size: 0.8rem;
            }
            
            .dashboard-content {
                padding: 16px 12px 0 12px;
            }
            
            .betting-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .betting-controls .btn {
                width: 100%;
                justify-content: center;
            }
            
            .betting-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .betting-stat-card {
                padding: 10px;
            }
            
            .betting-stat-card .value {
                font-size: 1.2rem;
            }
            
            .betting-card {
                padding: 12px;
            }
            
            .betting-card-title {
                font-size: 1rem;
            }
            
            .betting-modal-content {
                width: 98%;
                margin: 10px;
                padding: 16px;
            }
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'DM Sans', 'Inter', Arial, sans-serif;
            min-height: 44px; /* Touch-friendly minimum size */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* War Logs Styles */
        .warlogs-controls {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .warlogs-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
        }

        .stat-card h3 {
            color: #6b7280;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #232526;
        }

        .warlogs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            overflow: hidden;
        }

        .war-card {
            border-bottom: 1px solid #e5e7eb;
            padding: 20px;
            transition: all 0.2s;
        }

        .war-card:hover {
            background: #f9fafb;
        }

        .war-card:last-child {
            border-bottom: none;
        }

        .war-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .war-id {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .war-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .war-status.active {
            background: #dcfce7;
            color: #166534;
        }

        .war-status.finished {
            background: #f3f4f6;
            color: #6b7280;
        }

        .war-status.preparing {
            background: #fef3c7;
            color: #92400e;
        }

        .war-factions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 16px;
        }

        .war-faction {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .war-faction.winner {
            border-color: #059669;
            background: #f0fdf4;
        }

        .faction-name {
            font-weight: 600;
            color: #232526;
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .faction-score {
            font-size: 1.2rem;
            font-weight: 700;
            color: #059669;
            margin-bottom: 4px;
        }

        .faction-details {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .war-meta {
            display: flex;
            gap: 20px;
            font-size: 0.85rem;
            color: #6b7280;
            flex-wrap: wrap;
        }

        .war-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        @media (max-width: 768px) {
            .war-factions {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .war-meta {
                flex-direction: column;
                gap: 8px;
            }
            
            .warlogs-controls {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .warlogs-stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .stat-card {
                padding: 16px;
            }
            
            .stat-card .value {
                font-size: 1.5rem;
            }
            
            .war-card {
                padding: 16px;
            }
            
            .war-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .war-factions {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .war-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .warlogs-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-card .value {
                font-size: 1.3rem;
            }
            
            .war-card {
                padding: 12px;
            }
        }
        
        /* User Bet Tracking Styles */
        .user-betting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .user-betting-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #232526;
        }

        .user-betting-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .user-bets-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .user-bet-stat-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .user-bet-stat-card h3 {
            color: #6b7280;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .user-bet-stat-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #232526;
        }

        .user-bet-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .user-bet-card:hover {
            box-shadow: 0 4px 16px rgba(35,37,38,0.08);
            transform: translateY(-1px);
        }

        .user-bet-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f3f4f6;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-bet-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #232526;
        }

        .user-bet-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .user-bet-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .user-bet-status.confirmed {
            background: #dbeafe;
            color: #1e40af;
        }

        .user-bet-status.won {
            background: #dcfce7;
            color: #166534;
        }

        .user-bet-status.lost {
            background: #fee2e2;
            color: #dc2626;
        }

        .user-bet-status.paid {
            background: #f0fdf4;
            color: #059669;
        }

        .user-bet-content {
            padding: 20px;
        }

        .user-bet-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .user-bet-detail {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-bet-detail-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-bet-detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: #232526;
        }

        .user-bet-war-status {
            margin-top: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .user-bet-war-status-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #374151;
        }

        .user-bet-war-status-icon {
            font-size: 1.1rem;
        }

        .user-bet-war-status-text {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-bet-scores {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-bet-score-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: #ffffff;
            border-radius: 6px;
            border: 1px solid #f3f4f6;
        }

        .user-bet-score-faction {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .user-bet-score-name {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 120px;
        }

        .user-bet-score-value {
            font-weight: 600;
            font-size: 0.9rem;
            color: #f59e0b;
        }

        .user-faction .user-bet-score-value {
            color: #059669;
        }

        .opponent-faction .user-bet-score-value {
            color: #dc2626;
        }

        .user-bet-score-progress {
            flex: 1;
            max-width: 100px;
        }

        .user-bet-progress-bar {
            width: 100%;
            height: 6px;
            background: #f3f4f6;
            border-radius: 3px;
            overflow: hidden;
        }

        .user-bet-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .user-bet-target {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            background: #eff6ff;
            border-radius: 4px;
            border: 1px solid #dbeafe;
        }

        .user-bet-target-label {
            font-size: 0.8rem;
            color: #3b82f6;
            font-weight: 500;
        }

        .user-bet-target-value {
            font-size: 0.8rem;
            color: #1d4ed8;
            font-weight: 600;
        }

        .user-bet-live-timestamp {
            margin-top: 8px;
            padding: 4px 8px;
            background: #f0fdf4;
            border-radius: 4px;
            border: 1px solid #bbf7d0;
            text-align: center;
        }

        .user-bet-live-timestamp-text {
            font-size: 0.7rem;
            color: #059669;
            font-weight: 500;
        }

        .user-bet-lead-info {
            margin-top: 8px;
            padding: 6px 8px;
            background: #fef3c7;
            border-radius: 4px;
            border: 1px solid #f59e0b;
            text-align: center;
        }

        .user-bet-lead-info-text {
            font-size: 0.8rem;
            color: #92400e;
            font-weight: 600;
        }

        .user-bet-detail-value a {
            color: #059669;
            text-decoration: none;
        }

        .user-bet-detail-value a:hover {
            text-decoration: underline;
        }

        .user-bet-payout {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .user-bet-payout-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #166534;
            margin-bottom: 8px;
        }

        .user-bet-payout-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: #059669;
        }

        .user-bet-payout-status {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .user-bet-payout-status.paid {
            color: #059669;
            font-weight: 600;
        }

        .user-bet-payout-status.pending {
            color: #f59e0b;
            font-weight: 600;
        }

        .user-bet-message {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #374151;
        }

        .user-bet-actions {
            padding: 16px 20px;
            border-top: 1px solid #f3f4f6;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-bet-time {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .user-bet-buttons {
            display: flex;
            gap: 8px;
        }

        .user-bet-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-bet-btn-primary {
            background: #059669;
            color: white;
        }

        .user-bet-btn-primary:hover {
            background: #047857;
        }

        .user-bet-btn-secondary {
            background: #6b7280;
            color: white;
        }

        .user-bet-btn-secondary:hover {
            background: #4b5563;
        }

        .user-bet-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .no-bets-message {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .no-bets-message h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        .no-bets-message p {
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .user-betting-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .user-betting-controls {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .user-betting-controls .btn {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
            
            .user-betting-title {
                font-size: 1.3rem;
            }
            
            .user-bets-stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }
            
            .user-bet-stat-card {
                padding: 12px;
            }
            
            .user-bet-stat-card .value {
                font-size: 1.3rem;
            }
            
            .user-bet-card {
                margin-bottom: 12px;
            }
            
            .user-bet-header {
                padding: 12px 16px;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .user-bet-title {
                font-size: 1rem;
            }
            
            .user-bet-details {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .user-bet-actions {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .user-bet-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .center-box {
                max-width: 100%;
                padding: 16px;
            }
            
            .main-title {
                font-size: 2rem;
            }
            

            
            .user-betting-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .user-betting-controls .btn {
                width: 100%;
                justify-content: center;
            }
            
            .user-bets-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .user-bet-stat-card {
                padding: 10px;
            }
            
            .user-bet-stat-card .value {
                font-size: 1.2rem;
            }
            
            .user-bet-header {
                padding: 10px 12px;
            }
            
            .user-bet-title {
                font-size: 0.9rem;
            }
        }

        /* Bet Tracking Styles */
        .bet-tracking-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(35,37,38,0.04);
            border: 1px solid #e5e7eb;
            margin-top: 24px;
            overflow: hidden;
        }

        .bet-tracking-header {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bet-tracking-header h2 {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }

        .bet-tracking-toggle {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .bet-tracking-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        .bet-tracking-content {
            display: none;
            padding: 24px;
        }

        .bet-tracking-content.active {
            display: block;
        }

        /* Compact Stats Grid */
        .compact-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .compact-stat-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .compact-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .compact-stat-card h4 {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .compact-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .compact-stat-change {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .compact-stat-change.positive {
            background: #dcfce7;
            color: #166534;
        }

        .compact-stat-change.negative {
            background: #fee2e2;
            color: #dc2626;
        }

        .compact-stat-change.neutral {
            background: #f1f5f9;
            color: #64748b;
        }

        /* Bet Table Styles */
        .bet-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .bet-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .bet-table th {
            background: #f8fafc;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bet-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        .bet-table tbody tr:hover {
            background: #f8fafc;
        }

        .bet-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bet-status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .bet-status-confirmed {
            background: #dbeafe;
            color: #1e40af;
        }

        .bet-status-won {
            background: #dcfce7;
            color: #166534;
        }

        .bet-status-lost {
            background: #fee2e2;
            color: #dc2626;
        }

        .bet-status-paid {
            background: #f0fdf4;
            color: #059669;
        }

        .bet-amount {
            font-weight: 600;
            color: #059669;
            font-family: 'DM Sans', monospace;
        }

        .bet-payout {
            font-weight: 600;
            color: #7c3aed;
            font-family: 'DM Sans', monospace;
        }

        .bet-profit {
            font-weight: 600;
            font-family: 'DM Sans', monospace;
        }

        .bet-profit.positive {
            color: #059669;
        }

        .bet-profit.negative {
            color: #dc2626;
        }

        .bet-profit.neutral {
            color: #64748b;
        }

        .bet-actions {
            display: flex;
            gap: 4px;
        }

        .bet-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bet-action-btn.view {
            background: #dbeafe;
            color: #1e40af;
        }

        .bet-action-btn.edit {
            background: #fef3c7;
            color: #92400e;
        }

        .bet-action-btn.delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .bet-action-btn:hover {
            transform: scale(1.05);
        }

        /* Bet Filters */
        .bet-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .bet-filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
            color: #374151;
            min-width: 120px;
        }

        .bet-search-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            min-width: 200px;
        }

        .bet-search-input:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .bet-control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bet-control-btn.primary {
            background: #059669;
            color: white;
        }

        .bet-control-btn.secondary {
            background: #f1f5f9;
            color: #374151;
        }

        .bet-control-btn.danger {
            background: #dc2626;
            color: white;
        }

        .bet-control-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Bet Chart */
        .bet-chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .bet-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .bet-chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .bet-chart-legend {
            display: flex;
            gap: 16px;
            font-size: 0.8rem;
        }

        .bet-chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bet-chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .bet-chart-canvas {
            width: 100%;
            height: 200px;
            background: #f8fafc;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 0.9rem;
        }

        /* Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
                min-height: auto;
            }
            
            .dashboard-tabs {
                width: 100%;
                justify-content: center;
                order: 1;
            }
            
            .user-info-section {
                min-width: auto;
                width: 100%;
                justify-content: center;
                order: 2;
            }
            
            .dashboard-controls {
                width: 100%;
                justify-content: center;
                order: 3;
            }
            
            .compact-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .bet-table {
                font-size: 0.75rem;
            }
            
            .bet-table th,
            .bet-table td {
                padding: 8px 12px;
            }
            
            .bet-filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="center-box" id="mainBox">
        <div class="login-header">
            <h1 class="main-title">
                <span class="title-text">Find the best deals in</span>
                <span class="title-highlight">Torn City Betting</span>
            </h1>
            <p class="subtitle">Browse Ranked Wars from active faction wars with real-time odds and live updates.</p>
            <p class="call-to-action">Betting enthusiasts: Add your API key to access the Colosseum!</p>
                            <p class="info-message">ðŸ’¡ The system uses local faction data to avoid rate limiting. Your API key is only used for essential Torn City data.</p>
        </div>
        

        
        <div class="login-form">
            <div class="api-input">
                <input type="text" id="apiKey" placeholder="Enter Public Torn API KEY" minlength="16" maxlength="64">
                <button id="connectBtn" onclick="connectAPI()">Connect</button>
            </div>
            <div class="error-message" id="errorMsg"></div>
            <div class="success-message" id="successMsg"></div>
        </div>
    </div>
    <div id="dashboard" class="dashboard" style="display:none;">
        <div class="dashboard-header">
            <!-- Navigation Tabs (Left) -->
            <div class="dashboard-tabs">
                <button class="dashboard-tab active" data-tab="colosseum">Colosseum</button>
                <button class="dashboard-tab" data-tab="bettracking">Bet Tracking</button>
            </div>
            
            <!-- User Info Section (Right) -->
            <div class="user-info-section" id="user-info-section" style="display: none;">
                <div class="user-avatar" id="user-avatar">
                    ðŸ‘¤
                </div>
                <div class="user-details">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-level" id="user-level">Level: --</div>
                    <div class="user-faction" id="user-faction">Faction: --</div>
                </div>
            </div>
            
            <!-- Controls (Right) -->
            <div class="dashboard-controls">
                <button class="logout-btn" onclick="logout()">ðŸšª Logout</button>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="tab-content" id="tab-colosseum">
                <div class="betting-header">
                    <div class="betting-title">ðŸ›ï¸ Colosseum Betting</div>
                    <div class="betting-controls">
                        <span id="betting-last-updated" style="color: #6b7280; font-size: 0.9rem;"></span>
                    </div>
                </div>
                <div class="betting-info">
                    <p>ðŸ’° <strong>How Betting Works:</strong> Place bets on faction wars using Xanax as currency. Odds are displayed in decimal format (e.g., 2.00, 1.50) and calculated dynamically based on faction strength, historical performance, and current betting volume. <strong>Decimal odds</strong> show your total return - multiply your bet by the odds to get your payout. For example, 2.00 odds means bet 1 Xanax â†’ win 2 Xanax total (1 profit). Higher odds mean bigger potential returns, but lower probability of winning. Bet amounts are locked once the war starts, and payouts are calculated when the war ends. <strong>Selected Wars:</strong> Only the most interesting faction wars are available for betting, curated by our odds engine.</p>
                </div>
                    
                <div id="betting-loading" class="inventory-loading">Loading Ranked Wars...</div>
                <div id="betting-content" style="display:none;">
                    <div id="betting-stats" class="betting-stats"></div>
                    <div id="betting-filters" class="betting-filters">
                        <div class="search-container">
                            <input type="text" id="faction-search" placeholder="Search faction name..." class="faction-search-input">
                        </div>
                        <div class="filter-tabs">
                            <button class="filter-tab" data-filter="all">All Wars</button>
                            <button class="filter-tab" data-filter="active">Active</button>
                            <button class="filter-tab active" data-filter="upcoming">Upcoming</button>
                            <button class="filter-tab" data-filter="finished">Finished</button>
                        </div>
                    </div>
                    <div id="betting-grid" class="betting-grid"></div>
                </div>
                    </div>
                    
            <!-- Betting Modal -->
            <div id="betting-modal" class="betting-modal">
                <div class="betting-modal-content">
                    <div class="betting-modal-header">
                        <div class="betting-modal-title">Place Your Bet</div>
                        <button class="betting-modal-close" onclick="closeBettingModal()">&times;</button>
                                </div>
                    <div id="betting-modal-body">
                        <!-- Modal content will be populated dynamically -->
                            </div>
                        </div>
                        </div>




            <div class="tab-content" id="tab-bettracking" style="display:none;">
                
                <!-- Compact Stats Grid -->
                <div class="compact-stats-grid">
                    <div class="compact-stat-card">
                        <h4>Total Bets</h4>
                        <div class="compact-stat-value" id="total-bets">0</div>
                        <div class="compact-stat-change positive" id="total-bets-change">+0</div>
                    </div>
                    <div class="compact-stat-card">
                        <h4>Volume</h4>
                        <div class="compact-stat-value" id="total-volume">$0</div>
                        <div class="compact-stat-change positive" id="volume-change">+$0</div>
                    </div>
                    <div class="compact-stat-card">
                        <h4>Active</h4>
                        <div class="compact-stat-value" id="active-bets">0</div>
                        <div class="compact-stat-change neutral" id="active-change">0</div>
                    </div>
                    <div class="compact-stat-card">
                        <h4>Won</h4>
                        <div class="compact-stat-value" id="won-bets">0</div>
                        <div class="compact-stat-change positive" id="won-change">+0</div>
                    </div>
                    <div class="compact-stat-card">
                        <h4>Lost</h4>
                        <div class="compact-stat-value" id="lost-bets">0</div>
                        <div class="compact-stat-change negative" id="lost-change">+0</div>
                    </div>
                    <div class="compact-stat-card">
                        <h4>Payouts</h4>
                        <div class="compact-stat-value" id="total-payouts">$0</div>
                        <div class="compact-stat-change positive" id="payout-change">+$0</div>
                    </div>
                    <div class="compact-stat-card">
                        <h4>Profit</h4>
                        <div class="compact-stat-value" id="total-profit">$0</div>
                        <div class="compact-stat-change positive" id="profit-change">+$0</div>
                    </div>
                </div>



                <!-- Bet Filters -->
                <div class="bet-filters">
                    <select class="bet-filter-select" id="bet-status-filter">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="won">Won</option>
                        <option value="lost">Lost</option>
                        <option value="paid">Paid</option>
                    </select>
                    
                    <select class="bet-filter-select" id="bet-war-filter">
                        <option value="">All Wars</option>
                    </select>
                    
                    <button class="bet-control-btn secondary" onclick="clearBetFilters()">Clear Filters</button>
                </div>

                <!-- Bet Table -->
                <div class="bet-table-container">
                    <table class="bet-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>War</th>
                                <th>Faction</th>
                                <th>Amount</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Payout</th>
                                <th>Profit</th>
                                <th>Bet Message</th>
                            </tr>
                        </thead>
                        <tbody id="bet-table-body">
                            <!-- Bet data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let apiKey = '';
        let userData = null;

        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;
        
        // Betting system variables
        let bettingData = null;
        let bettingCache = null;
        let autoRefreshBettingInterval = null;
        let isAutoRefreshBettingEnabled = false;
        let selectedBet = null;
        const XANAX_PRICE =744983; // $700,000 per Xanax
        
        // API-based odds system
        let oddsAPI = {
            baseURL: 'http://localhost:3000',
            calculateOdds: null,
            healthCheck: null
        };
        let historicalData = {}; // Historical faction performance data
        let currentBettingVolume = {}; // Current betting volume data
        
        // Filter system
        let currentFilter = 'upcoming';
        let currentSearch = '';
        




        function connectAPI() {
            const apiKeyInput = document.getElementById('apiKey');
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');
            
            apiKey = apiKeyInput.value.trim();
            
            // Save API key to localStorage
            if (apiKey) {
                localStorage.setItem('tornApiKey', apiKey);
            }
            
            if (!apiKey) {
                errorMsg.textContent = 'Please enter your API key';
                return;
            }
            
            if (apiKey.length < 16) {
                errorMsg.textContent = 'API key must be at least 16 characters';
                return;
            }
            
            errorMsg.textContent = '';
            successMsg.textContent = 'Connecting...';
            
            // Test the API key by fetching user data
            fetch(`/api/auth/verify-key`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ apiKey: apiKey })
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Authentication failed');
                    }
                    
                    userData = data.player;
                    successMsg.textContent = 'Connected successfully!';
                    
                    // Update user info section
                    updateUserInfo(userData);
                    
                    // Show dashboard after a short delay
                    setTimeout(() => {
                        document.getElementById('mainBox').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'flex';
                        
                        
                        
                        // Automatically load betting interface since Colosseum tab is active by default
                        loadBettingInterface();
                        
                        // Enable automatic refresh for betting data
                        startAutoRefreshBetting();
                        
                        // Enable automatic refresh for user bets
                        startAutoRefreshUserBets();
                    }, 1000);
                })
                .catch(error => {
                    // Provide helpful error messages for rate limiting
                    if (error.message.includes('Too many requests') || error.message.includes('Rate limit')) {
                        errorMsg.textContent = 'Rate limit exceeded. The system will use local faction data instead.';
                        successMsg.textContent = 'Using local data...';
                        
                        // Still show dashboard but with cached data
                        setTimeout(() => {
                            document.getElementById('mainBox').style.display = 'none';
                            document.getElementById('dashboard').style.display = 'flex';
                            
                            // Load betting interface with cached data
                            loadBettingInterface();
                        }, 1000);
                    } else {
                        errorMsg.textContent = `Error: ${error.message}`;
                        successMsg.textContent = '';
                    }
                });
        }

        // Check for existing API key on page load
        function checkExistingApiKey() {
            const savedApiKey = localStorage.getItem('tornApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                apiKey = savedApiKey;
                // Auto-connect if API key exists
                connectAPI();
            }
        }

        // Logout function
        function logout() {
            // Clear API key from localStorage
            localStorage.removeItem('tornApiKey');
            
            // Reset variables
            apiKey = null;
            userData = null;
            
            // Hide user info section
            const userInfoSection = document.getElementById('user-info-section');
            if (userInfoSection) {
                userInfoSection.style.display = 'none';
            }
            
            // Show login screen
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('mainBox').style.display = 'flex';
            
            // Clear API key input
            document.getElementById('apiKey').value = '';
            
            // Clear messages
            document.getElementById('errorMsg').textContent = '';
            document.getElementById('successMsg').textContent = '';
            
            console.log('Logged out successfully');
        }

        // Update user info section with player data
        function updateUserInfo(playerData) {
            const userInfoSection = document.getElementById('user-info-section');
            const userName = document.getElementById('user-name');
            const userLevel = document.getElementById('user-level');
            const userFaction = document.getElementById('user-faction');
            const userAvatar = document.getElementById('user-avatar');
            
            if (playerData && playerData.name) {
                // Show the user info section
                userInfoSection.style.display = 'flex';
                
                // Update user name with player ID
                const playerId = playerData.player_id || playerData.playerId || '--';
                userName.textContent = `${playerData.name} (${playerId})`;
                
                // Update user level
                userLevel.textContent = `Level: ${playerData.level || '--'}`;
                
                // Update user faction
                userFaction.textContent = `Faction: ${playerData.faction || 'None'}`;
                
                // Update avatar with first letter of name
                const firstLetter = playerData.name.charAt(0).toUpperCase();
                userAvatar.textContent = firstLetter;
                
                console.log('âœ… User info updated:', playerData.name, 'ID:', playerId);
            } else {
                // Hide the user info section if no data
                userInfoSection.style.display = 'none';
                console.log('âš ï¸  No user data available');
            }
        }

        // Handle Enter key in API key input
        document.getElementById('apiKey').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                connectAPI();
            }
        });
        


        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.dashboard-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.style.display = 'none');
                    
                    // Add active class to clicked tab and show corresponding content
                    this.classList.add('active');
                    document.getElementById(`tab-${targetTab}`).style.display = 'block';
                    
                    // Load data when switching to tabs
                    if (targetTab === 'colosseum' && apiKey) {
                        loadBettingInterface();
                    } else if (targetTab === 'bettracking' && apiKey) {
                        loadBetData();
                    }
                });
            });
            
            // Filter tab functionality
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('filter-tab')) {
                    const filterTabs = document.querySelectorAll('.filter-tab');
                    filterTabs.forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    currentFilter = e.target.getAttribute('data-filter');
                    displayFilteredBettingCards();
                }
            });
            
            // Search functionality
            const searchInput = document.getElementById('faction-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    currentSearch = e.target.value;
                    displayFilteredBettingCards();
                });
            }
        });











        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            
            const date = new Date(parseInt(timestamp));
            
            // Format with user's local timezone
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            
            return date.toLocaleString(undefined, options);
        }

        function updateLastUpdated() {
            const lastUpdatedEl = document.getElementById('last-updated');
            const now = new Date();
            
            // Format with user's local timezone
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleString(undefined, options)}`;
        }

        function toggleAutoRefresh() {
            const toggleBtn = document.getElementById('auto-refresh-toggle');
            
            if (isAutoRefreshEnabled) {
                // Disable auto refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                isAutoRefreshEnabled = false;
                toggleBtn.textContent = 'â–¶ï¸ Auto Refresh';
            } else {
                // Enable auto refresh
    
                isAutoRefreshEnabled = true;
                toggleBtn.textContent = 'â¸ï¸ Auto Refresh';
            }
        }

        // Betting Cache System
        class BettingCache {
            constructor() {
                this.cacheKey = 'tornBettingData';
                this.cacheDuration = 5 * 60 * 1000; // 5 minutes
            }

            save(data) {
                const cacheData = {
                    data: data,
                    timestamp: Date.now(),
                    version: '1.0'
                };
                
                try {
                    localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
                    console.log('Betting data cached successfully');
                } catch (error) {
                    console.error('Error saving betting cache:', error);
                }
            }

            load() {
                try {
                    const stored = localStorage.getItem(this.cacheKey);
                    if (!stored) return null;

                    const parsed = JSON.parse(stored);
                    const age = Date.now() - parsed.timestamp;

                    if (age < this.cacheDuration) {
                        console.log('Using cached betting data');
                        return parsed.data;
                    } else {
                        console.log('Cached betting data expired, fetching fresh data');
                        return null;
                    }
            } catch (error) {
                    console.error('Error loading cached betting data:', error);
                    return null;
                }
            }

            clear() {
                localStorage.removeItem(this.cacheKey);
            }

            isValid() {
                const stored = localStorage.getItem(this.cacheKey);
                if (!stored) return false;

                try {
                    const parsed = JSON.parse(stored);
                    const age = Date.now() - parsed.timestamp;
                    return age < this.cacheDuration;
                } catch {
                    return false;
                }
            }
        }

        // Initialize betting cache
        bettingCache = new BettingCache();
        
        // Initialize API-based odds calculation
        initializeOddsAPI();
        
        // Initialize sample historical data
        // Sample data initialization removed - using real data only
        
        // Helper function to format odds display
        function formatOddsDisplay(odds) {
            if (typeof odds === 'number' && odds >= 1) {
                // Decimal odds format
                return odds.toFixed(2);
            } else if (typeof odds === 'string' && (odds.startsWith('+') || odds.startsWith('-'))) {
                // American odds format (legacy)
                return odds;
            } else if (typeof odds === 'number') {
                // Percentage format (legacy)
                return `${odds}%`;
            } else {
                // Fallback to reasonable decimal odds
                return '2.00';
            }
        }

        // Helper function to calculate returns for decimal odds
        function calculateReturns(odds, xanaxAmount = 1) {
            if (typeof odds === 'number' && odds >= 1) {
                // Decimal odds calculation - FIXED: Don't round Xanax amount, round final dollar amount
                return Math.round(xanaxAmount * odds * XANAX_PRICE);
            } else if (typeof odds === 'string' && (odds.startsWith('+') || odds.startsWith('-'))) {
                // American odds calculation (legacy)
                const oddsValue = parseInt(odds.replace('+', ''));
                const betValue = xanaxAmount * XANAX_PRICE;
                
                if (oddsValue > 0) {
                    // Positive odds: win $odds for every $100 bet
                    return Math.round(betValue + (betValue * (oddsValue / 100)));
                } else {
                    // Negative odds: bet $|odds| to win $100
                    return Math.round(betValue + (betValue * (100 / Math.abs(oddsValue))));
                }
            } else if (typeof odds === 'number') {
                // Legacy percentage calculation
                return Math.round(XANAX_PRICE * (100 / odds));
            } else {
                // Fallback
                return XANAX_PRICE * 2;
            }
        }

        // Initialize API-based odds calculation
        function initializeOddsAPI() {
            // Calculate odds between two factions using the API
            oddsAPI.calculateOdds = async function(faction1Id, faction2Id) {
                try {
                    const response = await fetch(`${this.baseURL}/api/odds/calculate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            faction1Id: faction1Id.toString(),
                            faction2Id: faction2Id.toString()
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to calculate odds');
                    }
                    
                    return data.odds;
                } catch (error) {
                    console.error('Error calculating odds:', error);
                    // Return fallback odds if API fails
                    return {
                        [faction1Id]: {
                            odds: 2.00,
                            impliedProbability: 0.50,
                            trueProbability: 0.485,
                            format: 'decimal',
                            bettingExamples: [
                                { bet: 1, totalReturn: 2, profit: 1, description: 'Bet 1 Xanax â†’ Win 2 Xanax total (1 profit)' }
                            ]
                        },
                        [faction2Id]: {
                            odds: 2.00,
                            impliedProbability: 0.50,
                            trueProbability: 0.515,
                            format: 'decimal',
                            bettingExamples: [
                                { bet: 1, totalReturn: 2, profit: 1, description: 'Bet 1 Xanax â†’ Win 2 Xanax total (1 profit)' }
                            ]
                        },
                        metadata: {
                            confidence: 0,
                            timestamp: new Date(),
                            fallback: true
                        }
                    };
                }
            };
            
            // Health check for the odds engine
            oddsAPI.healthCheck = async function() {
                try {
                    const response = await fetch(`${this.baseURL}/api/odds/health`);
                    const data = await response.json();
                    return data.success ? data.health : null;
                } catch (error) {
                    console.error('Error checking odds engine health:', error);
                    return null;
                }
            };
            
            console.log('Odds API initialized');
        }
        
        // Sample data functions removed - using real data only

        // Betting System Functions
        async function loadBettingInterface() {
            if (!apiKey) {
                console.error('No API key available');
                return;
            }

            const loadingEl = document.getElementById('betting-loading');
            const contentEl = document.getElementById('betting-content');
            
            // Try to load from cache first
            const cachedData = bettingCache.load();
            if (cachedData) {
                bettingData = cachedData;
                displayBettingInterface();
                updateBettingLastUpdated();
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            }
            
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';

            try {
                // Load selected betting wars from the JSON file
                let bettingWarsData;
                try {
                    const bettingWarsResponse = await fetch('/data/betting-wars.json');
                    bettingWarsData = await bettingWarsResponse.json();
                } catch (error) {
                    console.warn('Could not load betting-wars.json, using all available wars as fallback');
                    bettingWarsData = { weeks: [] }; // Empty weeks array will use all wars
                }
                
                // Extract war IDs from the betting-wars.json file
                let currentWars = [];
                if (bettingWarsData.warIds && bettingWarsData.warIds.length > 0) {
                    // Use the warIds array from the JSON file
                    currentWars = bettingWarsData.warIds;
                    console.log(`Loaded ${currentWars.length} wars from betting-wars.json`);
                } else if (bettingWarsData.weeks && bettingWarsData.weeks.length > 0) {
                    // Fallback for weeks format
                    const currentWeek = bettingWarsData.weeks[bettingWarsData.weeks.length - 1];
                    currentWars = currentWeek.wars || [];
                    console.log(`Loaded ${currentWars.length} wars from current week (${bettingWarsData.weeks.length} weeks of history)`);
                } else if (bettingWarsData.wars) {
                    // Fallback for old format
                    currentWars = bettingWarsData.wars;
                    console.log(`Loaded ${currentWars.length} wars from legacy format`);
                }
                
                if (currentWars.length === 0) {
                    console.log('No betting wars specified, using all available wars');
                    currentWars = []; // Empty array means use all wars
                }

                // Fetch all ranked wars data
                const warsResponse = await fetch(`/api/torn/rankedwars?key=${apiKey}`);
                const warsData = await warsResponse.json();

                if (warsData.error) {
                    throw new Error(warsData.error.error);
                }

                // Filter wars to only include the selected betting wars
                let selectedWars = {};
                if (currentWars.length === 0) {
                    // If no specific wars are selected, use all available wars
                    selectedWars = warsData.rankedwars;
                } else {
                    // Use only the selected wars
                    currentWars.forEach(warId => {
                        if (warsData.rankedwars[warId]) {
                            selectedWars[warId] = warsData.rankedwars[warId];
                        }
                    });
                }

                // Fetch enhanced faction data for selected wars only
                const factionEnhancedData = await fetchFactionChainData(selectedWars, apiKey);

                // Transform selected war data into betting format
                bettingData = await transformWarDataToBetting(selectedWars, factionEnhancedData);
                
                console.log(`Loaded ${Object.keys(selectedWars).length} wars for betting (${currentWars.length} selected from betting-wars.json)`);
                
                // Store the count of selected betting wars for UI display
                window.bettingWarsCount = currentWars.length;
                
                // Cache the data
                bettingCache.save(bettingData);
                
                displayBettingInterface();
                updateBettingLastUpdated();
                
            } catch (error) {
                console.error('Error fetching betting data:', error);
                loadingEl.textContent = `Error: ${error.message}`;
                
                // If fetch failed but we have cached data, show it
                if (cachedData) {
                    bettingData = cachedData;
                    displayBettingInterface();
                    updateBettingLastUpdated();
                    loadingEl.style.display = 'none';
                    contentEl.style.display = 'block';
                }
            }
        }

        async function fetchFactionChainData(warData, apiKey) {
            const factionEnhancedData = {};
            const uniqueFactionIds = new Set();
            
            // Collect all unique faction IDs from wars
            Object.values(warData || {}).forEach(war => {
                Object.keys(war.factions).forEach(factionId => {
                    uniqueFactionIds.add(factionId);
                });
            });
            
            // Load local faction data
            let localFactionData = {};
            try {
                console.log('Loading local faction data...');
                const localResponse = await fetch('/data/factions.json');
                const localResult = await localResponse.json();
                
                if (localResult.factions) {
                    // Convert array to object for easier lookup
                    localFactionData = localResult.factions.reduce((acc, faction) => {
                        acc[faction.id] = faction;
                        return acc;
                    }, {});
                    console.log(`Loaded ${Object.keys(localFactionData).length} factions from local data`);
                } else {
                    console.warn('Failed to load local faction data');
                }
            } catch (error) {
                console.warn('Error loading local faction data:', error);
            }
            
            // Use only local faction data to avoid rate limiting
            Array.from(uniqueFactionIds).forEach((factionId) => {
                const localData = localFactionData[factionId] || {};
                factionEnhancedData[factionId] = {
                    chain: localData.chain || 0,
                    respect: localData.respect || null,
                    rank: localData.rank || null,
                    members: localData.members || null,
                    position: localData.position || null
                };
            });
            
            console.log('Fetched enhanced faction data:', factionEnhancedData);
            console.log('Total factions with enhanced data:', Object.keys(factionEnhancedData).length);
            console.log('Sample enhanced data:', Object.entries(factionEnhancedData).slice(0, 3));
            
            // Log factions with respect data
            const factionsWithRespect = Object.entries(factionEnhancedData)
                .filter(([id, data]) => data.respect !== null)
                .length;
            console.log(`Factions with respect data: ${factionsWithRespect}/${Object.keys(factionEnhancedData).length}`);
            
            return factionEnhancedData;
        }

        async function transformWarDataToBetting(warData, factionEnhancedData = {}) {
            const bettingMarkets = [];
            
            // Load real faction data for names
            let realFactionData = {};
            try {
                const factionResponse = await fetch('/data/factions.json');
                const factionResult = await factionResponse.json();
                if (factionResult.factions) {
                    realFactionData = factionResult.factions.reduce((acc, faction) => {
                        acc[faction.id] = faction;
                        return acc;
                    }, {});
                    console.log(`âœ… Loaded ${Object.keys(realFactionData).length} real factions for names`);
                    console.log('ðŸ“Š Sample faction data:', Object.entries(realFactionData).slice(0, 3));
                }
            } catch (error) {
                console.warn('âŒ Error loading real faction data:', error);
            }
            
            // Process only real war data - no sample data
            for (const [warId, war] of Object.entries(warData || {})) {
                const factionIds = Object.keys(war.factions);
                const faction1 = war.factions[factionIds[0]];
                const faction2 = war.factions[factionIds[1]];
                
                console.log(`\nðŸ” Processing War ${warId}:`);
                console.log(`   Faction IDs: ${factionIds[0]} vs ${factionIds[1]}`);
                console.log(`   Faction IDs type check: ${typeof factionIds[0]} vs ${typeof factionIds[1]}`);
                
                // Get enhanced faction data (chain, respect, rank, etc.)
                const faction1Enhanced = factionEnhancedData[factionIds[0]] || { chain: 0, respect: null, rank: null, members: null, position: null };
                const faction2Enhanced = factionEnhancedData[factionIds[1]] || { chain: 0, respect: null, rank: null, members: null, position: null };
                
                // Get real faction names from factions.json
                // Convert faction IDs to numbers for proper lookup
                const faction1IdNum = parseInt(factionIds[0]);
                const faction2IdNum = parseInt(factionIds[1]);
                const realFaction1 = realFactionData[faction1IdNum] || {};
                const realFaction2 = realFactionData[faction2IdNum] || {};
                
                console.log(`   Real faction 1 lookup: ID ${factionIds[0]} -> ${realFaction1.name || 'NOT FOUND'}`);
                console.log(`   Real faction 2 lookup: ID ${factionIds[1]} -> ${realFaction2.name || 'NOT FOUND'}`);
                
                // Log enhanced data usage for debugging
                console.log(`   Enhanced data 1: Chain: ${faction1Enhanced.chain}, Respect: ${faction1Enhanced.respect?.toLocaleString() || 'N/A'}, Rank: ${faction1Enhanced.rank || 'N/A'}, Members: ${faction1Enhanced.members || 'N/A'}`);
                console.log(`   Enhanced data 2: Chain: ${faction2Enhanced.chain}, Respect: ${faction2Enhanced.respect?.toLocaleString() || 'N/A'}, Rank: ${faction2Enhanced.rank || 'N/A'}, Members: ${faction2Enhanced.members || 'N/A'}`);
                
                // Create war data with enhanced faction information
                const warDataWithEnhancedInfo = {
                    id: warId,
                    factions: {
                        [factionIds[0]]: { ...faction1, ...faction1Enhanced },
                        [factionIds[1]]: { ...faction2, ...faction2Enhanced }
                    },
                    war: war.war
                };
                
                // Calculate odds using the new API-based system
                console.log(`   ðŸŽ¯ Calculating odds for factions ${factionIds[0]} vs ${factionIds[1]}...`);
                const calculatedOdds = await oddsAPI.calculateOdds(factionIds[0], factionIds[1]);
                const odds1 = calculatedOdds[factionIds[0]]?.odds || 2.00;
                const odds2 = calculatedOdds[factionIds[1]]?.odds || 2.00;
                
                console.log(`   âœ… Calculated odds: Faction ${factionIds[0]} = ${odds1}, Faction ${factionIds[1]} = ${odds2}`);
                console.log(`   ðŸ“Š Full odds response:`, calculatedOdds);
                
                // Determine actual status based on current time and war state
                const now = Math.floor(Date.now() / 1000);
                let actualStatus;
                if (war.war.winner !== 0) {
                    actualStatus = 'finished';
                } else if (war.war.start > now) {
                    actualStatus = 'preparing';
                } else {
                    actualStatus = 'active';
                }
                
                bettingMarkets.push({
                    id: warId,
                    title: `War #${warId}`,
                    subtitle: `Lead Target: ${war.war.target.toLocaleString()}`,
                    status: actualStatus,
                    startTime: war.war.start,
                    endTime: war.war.end || 0,
                    target: war.war.target,
                    winner: war.war.winner,
                    options: [
                        {
                            id: factionIds[0],
                            name: realFaction1.name || `Faction ${factionIds[0]}`,
                            score: faction1.score,
                            chain: faction1Enhanced.chain,
                            respect: faction1Enhanced.respect,
                            rank: faction1Enhanced.rank,
                            members: faction1Enhanced.members,
                            position: faction1Enhanced.position,
                            odds: odds1,
                            volume: 0
                        },
                        {
                            id: factionIds[1],
                            name: realFaction2.name || `Faction ${factionIds[1]}`,
                            score: faction2.score,
                            chain: faction2Enhanced.chain,
                            respect: faction2Enhanced.respect,
                            rank: faction2Enhanced.rank,
                            members: faction2Enhanced.members,
                            position: faction2Enhanced.position,
                            odds: odds2,
                            volume: 0
                        }
                    ],
                    totalVolume: 0
                });
            }

            console.log(`Processed ${bettingMarkets.length} real wars for betting`);
            return bettingMarkets;
        }

        function displayBettingInterface() {
            const loadingEl = document.getElementById('betting-loading');
            const contentEl = document.getElementById('betting-content');
            const statsEl = document.getElementById('betting-stats');
            const gridEl = document.getElementById('betting-grid');

            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';

            if (!bettingData || bettingData.length === 0) {
                gridEl.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No Ranked Wars available</div>';
                return;
            }

            // Display statistics
            displayBettingStats();

            // Display betting cards with current filter
            displayFilteredBettingCards();
        }
        
        function displayFilteredBettingCards() {
            const gridEl = document.getElementById('betting-grid');
            
            if (!bettingData) return;
            
            let filteredData = bettingData;
            
            // Apply current filter
            if (currentFilter !== 'all') {
                filteredData = bettingData.filter(market => {
                    if (currentFilter === 'active') {
                        return market.status === 'active';
                    } else if (currentFilter === 'upcoming') {
                        return market.status === 'preparing';
                    } else if (currentFilter === 'finished') {
                        return market.status === 'finished';
                    }
                    return true;
                });
            }
            
            // Apply search filter
            if (currentSearch.trim() !== '') {
                const searchTerm = currentSearch.toLowerCase().trim();
                filteredData = filteredData.filter(market => {
                    return market.options.some(option => 
                        option.name.toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            if (filteredData.length === 0) {
                let message = 'No Ranked Wars available';
                if (currentFilter !== 'all') {
                    message = `No ${currentFilter} Ranked Wars available`;
                }
                if (currentSearch.trim() !== '') {
                    message = `No Ranked Wars found for "${currentSearch}"`;
                }
                gridEl.innerHTML = `<div style="text-align: center; padding: 40px; color: #6b7280;">${message}</div>`;
                return;
            }
            
            gridEl.innerHTML = filteredData.map(market => createBettingCard(market)).join('');
        }

        function displayBettingStats() {
            const statsEl = document.getElementById('betting-stats');
            
            if (!bettingData) return;

            const stats = {
                total: bettingData.length,
                active: bettingData.filter(market => market.status === 'active').length,
                finished: bettingData.filter(market => market.status === 'finished').length
            };

            // Check if we're using selected betting wars
            const isUsingSelectedWars = window.bettingWarsCount && window.bettingWarsCount > 0;
            const statusIndicator = isUsingSelectedWars ? 
                '<div style="background: #dcfce7; color: #166534; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; margin-bottom: 12px;"><strong>ðŸŽ¯ Selected Wars:</strong> Using curated betting wars from betting-wars.json</div>' : 
                '<div style="background: #fef3c7; color: #92400e; padding: 8px 12px; border-radius: 6px; font-size: 0.8rem; margin-bottom: 12px;"><strong>âš ï¸ All Wars:</strong> Using all available wars (betting-wars.json not found or empty)</div>';

            statsEl.innerHTML = `
                ${statusIndicator}
                <div class="betting-stat-card">
                    <h3>Total Wars</h3>
                    <div class="value">${stats.total}</div>
                </div>
                <div class="betting-stat-card">
                    <h3>Active Wars</h3>
                    <div class="value">${stats.active}</div>
                </div>
                <div class="betting-stat-card">
                    <h3>Finished Wars</h3>
                    <div class="value">${stats.finished}</div>
                </div>
            `;
        }

        function createBettingCard(market) {
            const status = getBettingStatus(market.status);
            const startTime = formatTimestamp(market.startTime);
            const timerHtml = generateTimerHtml(market);
            
            return `
                <div class="betting-card" data-market-id="${market.id}">
                    <div class="betting-card-header">
                        <div class="betting-card-title">${market.title}</div>
                        <div class="betting-card-subtitle">
                            <span>${market.subtitle}</span>
                            <span class="betting-card-status ${status.class}">${status.text}</span>
                        </div>
                        ${timerHtml}
                    </div>
                    
                    <div class="betting-card-content">
                        <div class="betting-options">
                            ${market.options.map(option => `
                                <div class="betting-option" onclick="selectBettingOption('${market.id}', '${option.id}')">
                                    <div class="betting-option-left">
                                        <div class="betting-option-name">
                                            <a href="https://www.torn.com/factions.php?step=profile&ID=${option.id}" target="_blank" onclick="event.stopPropagation()">
                                                ${option.name}
                                            </a>
                                </div>
                                <div class="betting-option-details">
                                    Score: ${option.score.toLocaleString()} | Chain: ${option.chain}
                                </div>
                        </div>
                                    <div class="betting-option-right">
                                        <div class="betting-odds">${formatOddsDisplay(option.odds)}</div>
                                        <div class="betting-returns">$${calculateReturns(option.odds, 2).toLocaleString()}</div>
                    </div>
                        </div>
                            `).join('')}
                    </div>
            </div>
                    
                    <div class="betting-card-footer">
                        <div class="betting-volume">${market.totalVolume > 0 ? `Volume: $${(market.totalVolume / 1000000).toFixed(1)}M` : 'No bets placed'}</div>
                        <div class="betting-actions">
                            ${market.status === 'finished' ? 
                                `<a href="https://www.torn.com/war.php?step=rankreport&rankID=${market.id}" target="_blank" class="betting-report-link">ðŸ“Š View Report</a>` : 
                                canPlaceBet(market) ? 
                                    `<button class="betting-action-btn" onclick="placeBet('${market.id}')">Place Bet</button>` :
                                    `<button class="betting-action-btn" disabled>Coming Soon</button>`
                            }
                        </div>
                    </div>
                    </div>
                `;
        }

        function getBettingStatus(status) {
            switch (status) {
                case 'active':
                    return { text: 'Active', class: 'active' };
                case 'finished':
                    return { text: 'Finished', class: 'finished' };
                case 'preparing':
                    return { text: 'Upcoming', class: 'preparing' };
                default:
                    return { text: 'Unknown', class: 'finished' };
            }
        }

        function generateTimerHtml(market) {
            const now = Math.floor(Date.now() / 1000);
            const startTime = market.startTime;
            const endTime = market.endTime || 0;
            
            // Determine actual status based on current time
            let actualStatus = market.status;
            if (market.status === 'preparing' && startTime <= now) {
                actualStatus = 'active';
            }
            
            if (actualStatus === 'finished') {
                const duration = endTime > startTime ? endTime - startTime : 0;
                return `
                    <div class="betting-timer finished">
                        <span class="betting-timer-icon">ðŸ</span>
                        <span>${formatDuration(duration)}</span>
                    </div>
                `;
            } else if (actualStatus === 'active') {
                const duration = now - startTime;
                return `
                    <div class="betting-timer duration" data-start-time="${startTime}">
                        <span class="betting-timer-icon">â±ï¸</span>
                        <span class="timer-text">${formatDuration(duration)}</span>
                    </div>
                `;
            } else {
                // Preparing - countdown to start
                const timeUntilStart = startTime - now;
                if (timeUntilStart > 0) {
                    return `
                        <div class="betting-timer countdown" data-start-time="${startTime}">
                            <span class="betting-timer-icon">â³</span>
                            <span class="timer-text">${formatCountdown(timeUntilStart)}</span>
                        </div>
                    `;
                } else {
                    // Should be active but marked as preparing
                    const duration = Math.abs(now - startTime);
                    return `
                        <div class="betting-timer duration" data-start-time="${startTime}">
                            <span class="betting-timer-icon">â±ï¸</span>
                            <span class="timer-text">${formatDuration(duration)}</span>
                        </div>
                    `;
                }
            }
        }

        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds}s`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}m ${remainingSeconds}s`;
            } else if (seconds < 86400) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                return `${hours}h ${minutes}m ${remainingSeconds}s`;
            } else {
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${days}d ${hours}h ${minutes}m`;
            }
        }

        function formatCountdown(seconds) {
            if (seconds < 60) {
                return `${seconds}s`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}m ${remainingSeconds}s`;
            } else if (seconds < 86400) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                return `${hours}h ${minutes}m ${remainingSeconds}s`;
                    } else {
                const days = Math.floor(seconds / 86400);
                const hours = Math.floor((seconds % 86400) / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${days}d ${hours}h ${minutes}m`;
            }
        }

        function selectBettingOption(marketId, optionId) {
            // Remove previous selections
            document.querySelectorAll('.betting-option.selected').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Add selection to clicked option
            const optionEl = document.querySelector(`[onclick="selectBettingOption('${marketId}', '${optionId}')"]`);
            if (optionEl) {
                optionEl.classList.add('selected');
            }
        }

        function placeBet(marketId) {
            const market = bettingData.find(m => m.id === marketId);
            if (!market || !canPlaceBet(market)) return;

            selectedBet = { marketId, market };
            openBettingModal();
        }

        function openBettingModal() {
            const modal = document.getElementById('betting-modal');
            const modalBody = document.getElementById('betting-modal-body');
            
            if (!selectedBet) return;

            const { market, marketId } = selectedBet;
            
            console.log('\nðŸŽ° BETTING MODAL DEBUG:');
            console.log('   Market ID:', marketId);
            console.log('   Market options:', market.options.map(opt => `${opt.id}: ${opt.name} (odds: ${opt.odds})`));
            console.log('   XANAX_PRICE:', XANAX_PRICE);
            console.log('   Market options detailed:', market.options.map(opt => ({
                id: opt.id,
                name: opt.name,
                odds: opt.odds,
                oddsType: typeof opt.odds
            })));
            
            modalBody.innerHTML = `
                <div class="betting-message">
                    Minimum bet: 1 Xanax ($${XANAX_PRICE.toLocaleString()})
                    ${market.status === 'preparing' ? '<br>â° This war starts soon - bet will be active when war begins!' : ''}
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Select Faction:</label>
                    <select id="betting-faction-select" class="betting-form-input" onchange="console.log('ðŸŽ¯ Faction selection changed to:', this.value); updateBettingCalculations();">
                        ${market.options.map(option => `
                            <option value="${option.id}">${option.name} (${formatOddsDisplay(option.odds)})</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Xanax Amount:</label>
                    <input type="number" id="betting-xanax-amount" class="betting-form-input" 
                           min="1" step="1" value="1" placeholder="Enter Xanax amount">
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Bet Value:</label>
                    <div style="padding: 12px; background: #f8fafc; border-radius: 6px; font-weight: 600;">
                        $<span id="betting-value-display">${XANAX_PRICE.toLocaleString()}</span>
                        </div>
                        </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Potential Return:</label>
                    <div style="padding: 12px; background: #f0fdf4; border-radius: 6px; font-weight: 600; color: #059669;">
                        $<span id="betting-return-display">${XANAX_PRICE.toLocaleString()}</span>
                        </div>
                    </div>
                
                <div class="betting-form-actions">
                    <button class="betting-form-btn betting-form-btn-secondary" onclick="closeBettingModal()">Cancel</button>
                    <button class="betting-form-btn betting-form-btn-primary" onclick="placeBetNow()">Place Bet</button>
                </div>
                `;
            
            modal.style.display = 'flex';
            
            // Add event listeners for real-time calculations
            document.getElementById('betting-xanax-amount').addEventListener('input', updateBettingCalculations);
            document.getElementById('betting-faction-select').addEventListener('change', updateBettingCalculations);
            
            // Initialize calculations
            updateBettingCalculations();
        }

        function updateBettingCalculations() {
            const xanaxAmount = parseInt(document.getElementById('betting-xanax-amount').value) || 1;
            const factionId = document.getElementById('betting-faction-select').value;
            const faction = selectedBet.market.options.find(opt => opt.id === factionId);
            
            console.log('\nðŸ’° BETTING CALCULATION DEBUG:');
            console.log('   Selected faction ID:', factionId, '(type:', typeof factionId, ')');
            console.log('   Available factions:', selectedBet.market.options.map(opt => `${opt.id} (${typeof opt.id}): ${opt.name} (${opt.odds})`));
            console.log('   ðŸ” Faction lookup result:', faction ? 'FOUND' : 'NOT FOUND');
            console.log('   ðŸ” Lookup comparison:', selectedBet.market.options.map(opt => `${opt.id} === ${factionId} = ${opt.id === factionId}`));
            console.log('   ðŸ” SelectedBet market ID:', selectedBet.marketId);
            console.log('   ðŸ” SelectedBet market options count:', selectedBet.market.options.length);
            
            if (!faction) {
                console.error('âŒ Faction not found for ID:', factionId);
                return;
            }
            
            console.log('   âœ… Found faction:', faction.name);
            console.log('   ðŸ“Š Faction data:', faction);
            console.log('   ðŸŽ¯ Odds value:', faction.odds, '(type:', typeof faction.odds, ')');
            
            const betValue = xanaxAmount * XANAX_PRICE;
            console.log('   ðŸ’µ Bet value calculation:', xanaxAmount, 'x', XANAX_PRICE, '=', betValue);
            
            // Calculate total return using decimal odds
            let totalReturn;
            if (typeof faction.odds === 'number' && faction.odds >= 1) {
                // Decimal odds calculation - FIXED: Don't round Xanax amount, round final dollar amount
                totalReturn = Math.round(xanaxAmount * faction.odds * XANAX_PRICE);
                console.log('   ðŸŽ² Decimal odds calculation (FIXED):');
                console.log('      Direct calculation:', xanaxAmount, 'x', faction.odds, 'x', XANAX_PRICE, '= $', totalReturn);
            } else if (typeof faction.odds === 'string' && (faction.odds.startsWith('+') || faction.odds.startsWith('-'))) {
                // American odds calculation (legacy)
                const oddsValue = parseInt(faction.odds.replace('+', ''));
                console.log('   ðŸŽ² American odds calculation (legacy):', faction.odds);
                
                if (oddsValue > 0) {
                    // Positive odds: win $odds for every $100 bet
                    totalReturn = Math.round(betValue + (betValue * (oddsValue / 100)));
                } else {
                    // Negative odds: bet $|odds| to win $100
                    totalReturn = Math.round(betValue + (betValue * (100 / Math.abs(oddsValue))));
                }
            } else if (typeof faction.odds === 'number') {
                // Legacy percentage calculation
                totalReturn = Math.round(betValue * (100 / faction.odds));
                console.log('   ðŸŽ² Legacy percentage calculation:', faction.odds);
            } else {
                // Fallback
                totalReturn = betValue * 2;
                console.log('   ðŸŽ² Fallback calculation (2x)');
            }
            
            document.getElementById('betting-value-display').textContent = betValue.toLocaleString();
            document.getElementById('betting-return-display').textContent = totalReturn.toLocaleString();
            
            console.log('   ðŸ’° Final result:');
            console.log('      Bet Value: $', betValue.toLocaleString());
            console.log('      Total Return: $', totalReturn.toLocaleString());
            console.log('      Profit: $', (totalReturn - betValue).toLocaleString());
        }

        function placeBetNow() {
            const xanaxAmount = parseInt(document.getElementById('betting-xanax-amount').value) || 1;
            const factionId = document.getElementById('betting-faction-select').value;
            const faction = selectedBet.market.options.find(opt => opt.id === factionId);
            
            if (!faction || xanaxAmount < 1) {
                alert('Please enter a valid Xanax amount (minimum 1)');
                return;
            }
            
            // Save bet to localStorage for tracking immediately
            const betResult = saveBetToTracking(selectedBet.marketId, factionId, xanaxAmount, faction.name);
            
            if (!betResult) {
                alert('Error saving bet. Please try again.');
                return;
            }
            
            // Show success message and bet details
            const betMessage = `BET:${selectedBet.marketId}:${factionId}:${xanaxAmount}:${betResult.betId}`;
            
            const modalBody = document.getElementById('betting-modal-body');
            modalBody.innerHTML = `
                <div class="betting-message" style="background: #dcfce7; border-color: #bbf7d0; color: #166534;">
                    âœ… Bet placed successfully! Your bet has been recorded and is now pending confirmation.
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Bet Details:</label>
                    <div style="padding: 12px; background: #f8fafc; border-radius: 6px; font-size: 0.9rem; line-height: 1.5;">
                        <strong>War:</strong> ${selectedBet.market.title}<br>
                        <strong>Faction:</strong> ${faction.name}<br>
                                                        <strong>Xanax Amount:</strong> ${xanaxAmount}<br>
                        <strong>Bet Value:</strong> $${(xanaxAmount * XANAX_PRICE).toLocaleString()}<br>
                        <strong>Status:</strong> <span style="color: #f59e0b; font-weight: 600;">Pending</span>
                        </div>
                    </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Bet Message (for Torn City):</label>
                    <div style="position: relative;">
                        <textarea id="betting-message-text" class="betting-form-input" rows="3" readonly>${betMessage}</textarea>
                        <button class="betting-copy-btn" onclick="copyBetMessage()" style="position: absolute; top: 8px; right: 8px;">
                            ðŸ“‹ Copy
                        </button>
                        </div>
                            </div>
                
                                        <div class="betting-form-group">
                            <label class="betting-form-label">Bookie:</label>
                            <div style="position: relative;">
                                <input type="text" value="VanillaScoop [3520571]" readonly class="betting-form-input" style="background: #f8fafc;">
                                <button class="betting-copy-btn" onclick="copyBookieName()" style="position: absolute; top: 8px; right: 8px;">
                                    Copy
                                </button>
                            </div>
                        </div>

                        <div class="betting-form-group">
                            <label class="betting-form-label">Next Steps:</label>
                            <div style="padding: 12px; background: #f0fdf4; border-radius: 6px; font-size: 0.9rem; line-height: 1.5;">
                                1. Copy the bet message above<br>
                                2. Go to Torn City and send ${xanaxAmount} Xanax to VanillaScoop [3520571]<br>
                                3. Paste the bet message in the item transfer message<br>
                                4. Your bet will be confirmed when the transfer is processed<br>
                                5. Check the Bet Tracking page to monitor your bet status
                            </div>
                        </div>
                
                <div class="betting-form-actions">
                    <button class="betting-form-btn betting-form-btn-secondary" onclick="closeBettingModal()">Close</button>
                    <button class="betting-form-btn betting-form-btn-primary" onclick="openBetTracking()">View Bet Tracking</button>
                    </div>
                `;

            // Show success notification
            showBetPlacedNotification(xanaxAmount, faction.name, selectedBet.market.title);
        }
        
        function generateBetMessage() {
            const xanaxAmount = parseInt(document.getElementById('betting-xanax-amount').value) || 1;
            const factionId = document.getElementById('betting-faction-select').value;
            const faction = selectedBet.market.options.find(opt => opt.id === factionId);
            
            if (!faction || xanaxAmount < 1) {
                alert('Please enter a valid Xanax amount (minimum 1)');
                return;
            }
            
            const betMessage = `BET:${selectedBet.marketId}:${factionId}:${xanaxAmount}`;
            
            const modalBody = document.getElementById('betting-modal-body');
            modalBody.innerHTML = `
                <div class="betting-message">
                    âœ… Bet message generated! Copy the message below and paste it when sending Xanax in Torn City.
                </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Bet Message:</label>
                    <div style="position: relative;">
                        <textarea id="betting-message-text" class="betting-form-input" rows="3" readonly>${betMessage}</textarea>
                        <button class="betting-copy-btn" onclick="copyBetMessage()" style="position: absolute; top: 8px; right: 8px;">
                            ðŸ“‹ Copy
                        </button>
                        </div>
                    </div>
                
                <div class="betting-form-group">
                    <label class="betting-form-label">Instructions:</label>
                    <div style="padding: 12px; background: #f8fafc; border-radius: 6px; font-size: 0.9rem; line-height: 1.5;">
                        1. Copy the bet message above<br>
                        2. Go to Torn City and send ${xanaxAmount} Xanax to the bookie<br>
                        3. Paste the bet message in the item transfer message<br>
                        4. Your bet will be confirmed when the transfer is processed
                        </div>
                        </div>
                
                <div class="betting-form-actions">
                    <button class="betting-form-btn betting-form-btn-secondary" onclick="closeBettingModal()">Close</button>
                    </div>
                `;
        }
        
        // Generate unique bet ID
        function generateBetId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Check if bet ID already exists
        function isBetIdUnique(betId) {
            const existingBets = localStorage.getItem('tornBets');
            if (!existingBets) return true;
            
            try {
                const bets = JSON.parse(existingBets);
                return !bets.some(bet => bet.betId === betId);
            } catch (error) {
                console.error('Error checking bet ID uniqueness:', error);
                return true;
            }
        }
        
        // Save bet to tracking system
        function saveBetToTracking(warId, factionId, xanaxAmount, factionName) {
            // Get existing bets from localStorage
            const existingBets = localStorage.getItem('tornBets');
            let bets = [];
            
            if (existingBets) {
                try {
                    bets = JSON.parse(existingBets);
                } catch (error) {
                    console.error('Error parsing existing bets:', error);
                    bets = [];
                }
            }
            
            // Generate unique bet ID
            let betId;
            do {
                betId = generateBetId();
            } while (!isBetIdUnique(betId));
            
            console.log('ðŸŽ¯ Generated bet ID:', betId);
            
            // Create new bet entry
            const newBet = {
                id: Date.now(), // Internal tracking ID
                betId: betId, // Unique bet ID for message
                playerId: userData?.playerId || 'Unknown', // Use actual player ID if available
                warId: warId,
                factionId: factionId,
                factionName: factionName,
                xanaxAmount: xanaxAmount,
                betAmount: xanaxAmount * XANAX_PRICE,
                timestamp: Date.now(),
                status: 'pending'
            };
            
            // Add to beginning of array (most recent first)
            bets.unshift(newBet);
            
            // Save back to localStorage
            try {
                localStorage.setItem('tornBets', JSON.stringify(bets));
                console.log('Bet saved to tracking:', newBet);
            } catch (error) {
                console.error('Error saving bet to tracking:', error);
                return null;
            }
            
            // Also save to server API
            saveBetToServer(newBet);
            
            return { id: newBet.id, betId: newBet.betId }; // Return both IDs
        }
        
        // Save bet to server API
        async function saveBetToServer(betData) {
            try {
                // Get the actual odds from the selected faction
                const factionId = betData.factionId;
                const faction = selectedBet?.market?.options?.find(opt => opt.id === factionId);
                const odds = faction?.odds || 2.0;
                
                console.log('ðŸŽ¯ Saving bet to server with odds:', odds, 'for faction:', faction?.name);
                console.log('ðŸ‘¤ User data available:', userData);
                console.log('ðŸ“ Player name being sent:', userData?.name || 'Unknown');
                
                const requestBody = {
                    playerId: betData.playerId,
                    warId: betData.warId,
                    factionId: betData.factionId,
                    factionName: betData.factionName,
                    xanaxAmount: betData.xanaxAmount,
                    betAmount: betData.betAmount,
                    betId: betData.betId, // Include the bet ID
                    playerName: userData?.name || 'Unknown', // Include the real player name
                    odds: odds,
                    timestamp: betData.timestamp
                };
                
                console.log('ðŸ“¤ Request body being sent to server:', requestBody);
                
                const response = await fetch('/api/betting/place-bet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… Bet saved to server:', result);
                } else {
                    console.error('âŒ Failed to save bet to server:', result.error);
                }
            } catch (error) {
                console.error('âŒ Error saving bet to server:', error);
            }
        }
        
        // Show bet placed notification
        function showBetPlacedNotification(xanaxAmount, factionName, warTitle) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #059669, #047857);
                color: white;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 350px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 1.1rem;">
                    ðŸŽ¯ Bet Placed Successfully!
                                </div>
                <div style="font-size: 0.9rem; line-height: 1.4;">
                    <strong>${xanaxAmount}</strong> on <strong>${factionName}</strong><br>
                    <span style="opacity: 0.9;">${warTitle}</span><br>
                    <span style="color: #fbbf24; font-weight: 600;">Status: Pending</span>
                                </div>
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
            
            // Add slideOut animation
            const slideOutStyle = document.createElement('style');
            slideOutStyle.textContent = `
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(slideOutStyle);
        }

        function copyBetMessage() {
            const messageText = document.getElementById('betting-message-text');
            messageText.select();
            document.execCommand('copy');
            
            const copyBtn = document.querySelector('.betting-copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'âœ… Copied!';
            copyBtn.style.background = '#059669';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.background = '#3b82f6';
            }, 2000);
        }

        function copyBookieName() {
            const bookieInput = document.querySelector('input[value="VanillaScoop [3520571]"]');
            if (bookieInput) {
                bookieInput.select();
                document.execCommand('copy');
                
                const copyBtn = document.querySelector('button[onclick="copyBookieName()"]');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'âœ… Copied!';
                copyBtn.style.background = '#059669';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '#3b82f6';
                }, 2000);
            }
        }

        function closeBettingModal() {
            const modal = document.getElementById('betting-modal');
            modal.style.display = 'none';
            selectedBet = null;
        }

        function updateBettingLastUpdated() {
            const lastUpdatedEl = document.getElementById('betting-last-updated');
            const now = new Date();
            
            // Format with user's local timezone
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleString(undefined, options)}`;
        }

        // Start automatic refresh for betting
        function startAutoRefreshBetting() {
            if (autoRefreshBettingInterval) {
                clearInterval(autoRefreshBettingInterval);
            }
            autoRefreshBettingInterval = setInterval(loadBettingInterface, 120000); // Refresh every 2 minutes
            isAutoRefreshBettingEnabled = true;
        }
        
        // Stop automatic refresh for betting
        function stopAutoRefreshBetting() {
            if (autoRefreshBettingInterval) {
                clearInterval(autoRefreshBettingInterval);
                autoRefreshBettingInterval = null;
            }
            isAutoRefreshBettingEnabled = false;
        }

        // Timer update functionality
        function updateTimers() {
            const now = Math.floor(Date.now() / 1000);
            
            // Update countdown timers
            document.querySelectorAll('.betting-timer.countdown[data-start-time]').forEach(timer => {
                const startTime = parseInt(timer.getAttribute('data-start-time'));
                const timeUntilStart = startTime - now;
                
                if (timeUntilStart > 0) {
                    const timerText = timer.querySelector('.timer-text');
                    if (timerText) {
                        timerText.textContent = formatCountdown(timeUntilStart);
                    }
                        } else {
                    // War has started, update to duration
                    timer.className = 'betting-timer duration';
                    timer.setAttribute('data-start-time', startTime);
                    timer.innerHTML = `
                        <span class="betting-timer-icon">â±ï¸</span>
                        <span class="timer-text">${formatDuration(0)}</span>
                    `;
                }
            });
            
            // Update duration timers
            document.querySelectorAll('.betting-timer.duration[data-start-time]').forEach(timer => {
                const startTime = parseInt(timer.getAttribute('data-start-time'));
                const duration = Math.abs(now - startTime);
                const timerText = timer.querySelector('.timer-text');
                if (timerText) {
                    timerText.textContent = formatDuration(duration);
                }
            });
            
            // Update any timers that might have wrong status
            document.querySelectorAll('.betting-timer').forEach(timer => {
                const startTime = parseInt(timer.getAttribute('data-start-time'));
                if (startTime) {
                    const timeUntilStart = startTime - now;
                    const currentClass = timer.className;
                    
                    if (timeUntilStart > 0 && !currentClass.includes('countdown')) {
                        // Should be countdown
                        timer.className = 'betting-timer countdown';
                        timer.innerHTML = `
                            <span class="betting-timer-icon">â³</span>
                            <span class="timer-text">${formatCountdown(timeUntilStart)}</span>
                        `;
                    } else if (timeUntilStart <= 0 && !currentClass.includes('duration')) {
                        // Should be duration
                        timer.className = 'betting-timer duration';
                        const duration = Math.abs(now - startTime);
                        timer.innerHTML = `
                            <span class="betting-timer-icon">â±ï¸</span>
                            <span class="timer-text">${formatDuration(duration)}</span>
                        `;
                    }
                }
            });
        }

        // Start timer updates
        setInterval(updateTimers, 1000); // Update every second
        
        // Start odds updates
        setInterval(updateOdds, 15000); // Update odds every 15 seconds
        
        // Update odds in real-time
        async function updateOdds() {
            if (!bettingData || !oddsAPI.calculateOdds) return;
            
            // Update odds for all Ranked Wars
            for (const market of bettingData) {
                if (market.options.length === 2) {
                    try {
                        const faction1Id = market.options[0].id;
                        const faction2Id = market.options[1].id;
                        
                        // Calculate new odds using API
                        const newOdds = await oddsAPI.calculateOdds(faction1Id, faction2Id);
                        
                        // Update market odds - handle new sportsbook format
                        if (newOdds[faction1Id] && typeof newOdds[faction1Id] === 'object') {
                            // New sportsbook format
                            market.options[0].odds = newOdds[faction1Id].odds;
                            market.options[0].impliedProbability = newOdds[faction1Id].impliedProbability;
                            market.options[0].trueProbability = newOdds[faction1Id].trueProbability;
                        } else {
                            // Fallback to reasonable decimal odds instead of percentage
                            market.options[0].odds = newOdds[faction1Id] || 2.00;
                        }
                        
                        if (newOdds[faction2Id] && typeof newOdds[faction2Id] === 'object') {
                            // New decimal format
                            market.options[1].odds = newOdds[faction2Id].odds;
                            market.options[1].impliedProbability = newOdds[faction2Id].impliedProbability;
                            market.options[1].trueProbability = newOdds[faction2Id].trueProbability;
                        } else {
                            // Fallback to reasonable decimal odds instead of percentage
                            market.options[1].odds = newOdds[faction2Id] || 2.00;
                        }
                        
                    } catch (error) {
                        console.error(`Failed to update odds for market ${market.id}:`, error);
                        // Keep existing odds on error
                    }
                }
            }
            
            // Refresh display if betting interface is active
            if (document.getElementById('betting-content').style.display !== 'none') {
                displayBettingInterface();
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('betting-modal');
            if (event.target === modal) {
                closeBettingModal();
            }
        });
        
        // Open bet tracking dashboard
        function openBetTracking() {
            // Switch to bet tracking tab
            const betTrackingTab = document.querySelector('[data-tab="bettracking"]');
            if (betTrackingTab) {
                betTrackingTab.click();
            }
        }
        

        

        

        

        
        function showBetConfirmedNotification(xanaxAmount, factionName, warId) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #059669, #047857);
                color: white;
                padding: 16px;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 350px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 1.1rem;">
                    âœ… Bet Confirmed!
                </div>
                <div style="font-size: 0.9rem; line-height: 1.4;">
                    <strong>${xanaxAmount}</strong> on <strong>${factionName}</strong><br>
                    <span style="opacity: 0.9;">War #${warId}</span><br>
                    <span style="color: #10b981; font-weight: 600;">Status: Confirmed</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        


        // Check if betting is allowed for a war
        function canPlaceBet(market) {
            const now = Math.floor(Date.now() / 1000);
            const warStartTime = market.startTime;
            const fiveDaysInSeconds = 5 * 24 * 60 * 60; // 5 days in seconds
            
            // Allow betting if:
            // 1. War is active (has started but not finished)
            // 2. War is upcoming but within 5 days of starting
            if (market.status === 'active') {
                return true;
            } else if (market.status === 'preparing') {
                const timeUntilStart = warStartTime - now;
                return timeUntilStart <= fiveDaysInSeconds && timeUntilStart > 0;
            }
            
            return false;
        }
        
        // Update openBetTracking to store window reference
        function openBetTracking() {
            // Switch to bet tracking tab
            const betTrackingTab = document.querySelector('[data-tab="bettracking"]');
            if (betTrackingTab) {
                betTrackingTab.click();
            }
        }
        


        // User Bet Tracking System
        let userBetsData = [];
        let autoRefreshUserBetsInterval = null;
        let isAutoRefreshUserBetsEnabled = false;

        // Load user's bets
        async function loadUserBets() {
            const loadingEl = document.getElementById('user-bets-loading');
            const contentEl = document.getElementById('user-bets-content');
            
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';

            try {
                // Check if user is authenticated
                if (!userData || !userData.playerId || !apiKey) {
                    console.log('User not authenticated, using localStorage fallback');
                    // Fallback to localStorage for non-authenticated users
                    const existingBets = localStorage.getItem('tornBets');
                    if (!existingBets) {
                        userBetsData = [];
                        displayUserBets();
                        return;
                    }

                    const allBets = JSON.parse(existingBets);
                    const currentPlayerId = userData?.playerId || 'Unknown';
                    userBetsData = allBets.filter(bet => 
                        bet.playerId.toString() === currentPlayerId.toString()
                    );
                } else {
                    // Use server API for authenticated users
                    console.log('Loading bets from server for player:', userData.playerId);
                    const response = await fetch(`/api/betting/my-bets/${userData.playerId}?apiKey=${apiKey}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        // Convert server data format to match local format
                        userBetsData = [
                            ...result.bets.activeBets.map(bet => ({
                                ...bet,
                                status: 'pending'
                            })),
                            ...result.bets.betHistory.map(bet => ({
                                ...bet,
                                status: bet.status || 'completed'
                            }))
                        ];
                        console.log('Loaded bets from server:', userBetsData.length);
                    } else {
                        console.error('Failed to load bets from server:', result.error);
                        userBetsData = [];
                    }
                }

                // Refresh live war data before displaying
                await refreshLiveWarData();

                displayUserBets();
                updateUserBetsLastUpdated();
                
            } catch (error) {
                console.error('Error loading user bets:', error);
                loadingEl.textContent = `Error: ${error.message}`;
            }
        }

        // Display user's bets
        function displayUserBets() {
            const loadingEl = document.getElementById('user-bets-loading');
            const contentEl = document.getElementById('user-bets-content');
            const statsEl = document.getElementById('user-bets-stats');
            const containerEl = document.getElementById('user-bets-container');

            loadingEl.style.display = 'none';
            contentEl.style.display = 'block';

            if (!userBetsData || userBetsData.length === 0) {
                containerEl.innerHTML = `
                    <div class="no-bets-message">
                        <h3>No bets placed yet</h3>
                        <p>Start betting on faction wars to see your activity here!</p>
                        <button class="btn btn-primary" onclick="switchToColosseum()">Go to Colosseum</button>
                    </div>
                `;
                return;
            }

            // Display statistics
            displayUserBetsStats();

            // Display bet cards
            containerEl.innerHTML = userBetsData.map(bet => createUserBetCard(bet)).join('');
        }

        // Display user betting statistics
        function displayUserBetsStats() {
            const statsEl = document.getElementById('user-bets-stats');
            
            if (!userBetsData) return;

            const stats = {
                total: userBetsData.length,
                pending: userBetsData.filter(bet => bet.status === 'pending').length,
                confirmed: userBetsData.filter(bet => bet.status === 'confirmed').length,
                won: userBetsData.filter(bet => bet.status === 'won').length,
                lost: userBetsData.filter(bet => bet.status === 'lost').length,
                totalValue: userBetsData.reduce((sum, bet) => sum + bet.betAmount, 0),
                totalPayouts: userBetsData
                    .filter(bet => bet.status === 'won')
                    .reduce((sum, bet) => sum + (bet.payoutAmount || 0), 0)
            };

            statsEl.innerHTML = `
                <div class="user-bet-stat-card">
                    <h3>Total Bets</h3>
                    <div class="value">${stats.total}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Total Value</h3>
                    <div class="value">$${(stats.totalValue / 1000000).toFixed(1)}M</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Pending</h3>
                    <div class="value">${stats.pending}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Confirmed</h3>
                    <div class="value">${stats.confirmed}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Won</h3>
                    <div class="value">${stats.won}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Lost</h3>
                    <div class="value">${stats.lost}</div>
                </div>
                <div class="user-bet-stat-card">
                    <h3>Total Payouts</h3>
                    <div class="value">$${(stats.totalPayouts / 1000000).toFixed(1)}M</div>
                </div>
            `;
        }

        // Create user bet card
        function createUserBetCard(bet) {
            const status = getUserBetStatus(bet.status);
            const timePlaced = formatTimestamp(bet.timestamp);
            const payoutAmount = calculatePayoutAmount(bet);
            const payoutStatus = getPayoutStatus(bet);
            const expectedWinPayout = calculateExpectedWinPayout(bet);
            const expectedLossAmount = calculateExpectedLossAmount(bet);
            
            // Get live war data for this bet
            const warData = getLiveWarData(bet.warId);
            const warStatus = getWarStatus(warData);
            const liveScores = getLiveScores(warData, bet.factionId);
            
            return `
                <div class="user-bet-card">
                    <div class="user-bet-header">
                        <div class="user-bet-title">Bet ${bet.betId}</div>
                        <span class="user-bet-status ${status.class}">${status.text}</span>
                    </div>
                    
                    <div class="user-bet-content">
                        <div class="user-bet-details">
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">War</div>
                                <div class="user-bet-detail-value">
                                    <a href="https://www.torn.com/war.php?step=rankreport&rankID=${bet.warId}" target="_blank">
                                        War #${bet.warId}
                                    </a>
                                </div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Faction</div>
                                <div class="user-bet-detail-value">
                                    <a href="https://www.torn.com/factions.php?step=profile&ID=${bet.factionId}" target="_blank">
                                        ${bet.factionName}
                                    </a>
                                </div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Xanax Amount</div>
                                <div class="user-bet-detail-value">${bet.xanaxAmount}</div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Bet Value</div>
                                <div class="user-bet-detail-value">$${(bet.betAmount / 1000000).toFixed(1)}M</div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Expected Win</div>
                                <div class="user-bet-detail-value" style="color: #059669;">$${(expectedWinPayout / 1000000).toFixed(1)}M</div>
                            </div>
                            
                            <div class="user-bet-detail">
                                <div class="user-bet-detail-label">Expected Loss</div>
                                <div class="user-bet-detail-value" style="color: #dc2626;">-$${(expectedLossAmount / 1000000).toFixed(1)}M</div>
                            </div>
                        </div>
                        
                        <!-- Live War Status -->
                        <div class="user-bet-war-status">
                            <div class="user-bet-war-status-header">
                                <span class="user-bet-war-status-icon">âš”ï¸</span>
                                <span class="user-bet-war-status-text">${warStatus}</span>
                            </div>
                            ${liveScores}
                        </div>
                        
                        ${bet.status === 'won' ? `
                            <div class="user-bet-payout">
                                <div class="user-bet-payout-title">ðŸŽ‰ Congratulations! You Won!</div>
                                <div class="user-bet-payout-amount">$${(payoutAmount / 1000000).toFixed(1)}M</div>
                                <div class="user-bet-payout-status ${payoutStatus.class}">${payoutStatus.text}</div>
                            </div>
                        ` : ''}
                        
                        ${bet.status === 'lost' ? `
                            <div class="user-bet-payout" style="background: #fef2f2; border-color: #fecaca;">
                                <div class="user-bet-payout-title" style="color: #dc2626;">âŒ Better luck next time!</div>
                                <div class="user-bet-payout-amount" style="color: #dc2626;">Lost ${bet.xanaxAmount}</div>
                            </div>
                        ` : ''}
                        
                        ${bet.status === 'pending' ? `
                            <div class="user-bet-message">
                                <strong>Bet Message:</strong><br>
                                ${generateBetMessage(bet)}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="user-bet-actions">
                        <div class="user-bet-time">Placed: ${timePlaced}</div>
                        <div class="user-bet-buttons">
                            ${bet.status === 'pending' ? `
                                <button class="user-bet-btn user-bet-btn-secondary" onclick="copyBetMessage('${bet.betId}')">ðŸ“‹ Copy Message</button>
                            ` : ''}
                            
                            ${bet.status === 'won' && payoutStatus.text === 'Pending' ? `
                                <button class="user-bet-btn user-bet-btn-primary" onclick="requestPayout('${bet.betId}')">ðŸ’° Request Payout</button>
                            ` : ''}
                            
                            ${bet.status === 'confirmed' ? `
                                <button class="user-bet-btn user-bet-btn-secondary" disabled>â³ Waiting for War End</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Get user bet status
        function getUserBetStatus(status) {
            switch (status) {
                case 'pending':
                    return { text: 'Pending', class: 'pending' };
                case 'confirmed':
                    return { text: 'Confirmed', class: 'confirmed' };
                case 'won':
                    return { text: 'Won', class: 'won' };
                case 'lost':
                    return { text: 'Lost', class: 'lost' };
                case 'paid':
                    return { text: 'Paid', class: 'paid' };
                default:
                    return { text: 'Unknown', class: 'pending' };
            }
        }

        // Calculate expected win payout (based on odds)
        function calculateExpectedWinPayout(bet) {
            // Use the actual odds from the bet
            const odds = bet.odds || 2.00;
            // For decimal odds: payout = bet amount * odds
            return Math.round(bet.betAmount * odds);
        }

        // Calculate expected loss amount (what they lose if they lose)
        function calculateExpectedLossAmount(bet) {
            // This is simply the bet amount they placed
            return bet.betAmount;
        }

        // Calculate payout amount (for won bets)
        function calculatePayoutAmount(bet) {
            if (bet.status !== 'won') return 0;
            
            // Use the same calculation as expected win payout
            return calculateExpectedWinPayout(bet);
        }

        // Get payout status
        function getPayoutStatus(bet) {
            if (bet.status !== 'won') {
                return { text: 'N/A', class: '' };
            }
            
            if (bet.payoutStatus === 'paid') {
                return { text: 'âœ… Paid', class: 'paid' };
            } else {
                return { text: 'â³ Pending', class: 'pending' };
            }
        }

        // Generate bet message for display
        function generateBetMessage(bet) {
            return `BET:${bet.warId}:${bet.factionId}:${bet.xanaxAmount}:${bet.betId}`;
        }

        // Copy bet message to clipboard
        function copyBetMessage(betId) {
            const bet = userBetsData.find(b => b.betId === betId);
            if (!bet) return;
            
            const message = generateBetMessage(bet);
            navigator.clipboard.writeText(message).then(() => {
                showUserNotification('Message Copied', 'Bet message copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = message;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showUserNotification('Message Copied', 'Bet message copied to clipboard!');
            });
        }

        // Request payout (placeholder function)
        function requestPayout(betId) {
            showUserNotification('Payout Requested', 'Your payout request has been submitted. You will be contacted soon!');
        }

        // Switch to Colosseum tab
        function switchToColosseum() {
            const colosseumTab = document.querySelector('[data-tab="colosseum"]');
            if (colosseumTab) {
                colosseumTab.click();
            }
        }

        // Update user bets last updated timestamp
        function updateUserBetsLastUpdated() {
            const lastUpdatedEl = document.getElementById('user-bets-last-updated');
            const now = new Date();
            
            // Format with user's local timezone
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            };
            
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleString(undefined, options)}`;
        }

        // Start automatic refresh for user bets
        function startAutoRefreshUserBets() {
            if (autoRefreshUserBetsInterval) {
                clearInterval(autoRefreshUserBetsInterval);
            }
            autoRefreshUserBetsInterval = setInterval(async () => {
                await refreshLiveWarData();
                displayUserBets(); // Re-render with updated data
            }, 120000); // Refresh every 2 minutes
            isAutoRefreshUserBetsEnabled = true;
        }
        
        // Stop automatic refresh for user bets
        function stopAutoRefreshUserBets() {
            if (autoRefreshUserBetsInterval) {
                clearInterval(autoRefreshUserBetsInterval);
                autoRefreshUserBetsInterval = null;
            }
            isAutoRefreshUserBetsEnabled = false;
        }

        // Get live war data from API cache
        function getLiveWarData(warId) {
            try {
                const liveData = localStorage.getItem('liveWarData');
                if (!liveData) return null;
                
                const parsed = JSON.parse(liveData);
                if (!parsed.data || !parsed.data[warId]) return null;
                
                // Check if data is fresh (less than 5 minutes old)
                const dataAge = Date.now() - parsed.timestamp;
                if (dataAge > 5 * 60 * 1000) { // 5 minutes
                    console.log('Live war data is stale, will refresh on next update');
                }
                
                return parsed.data[warId] || null;
            } catch (error) {
                console.error('Error getting live war data:', error);
                return null;
            }
        }

        // Get war status text and class
        function getWarStatus(warData) {
            if (!warData || !warData.war) return 'Unknown';
            
            const now = Math.floor(Date.now() / 1000);
            const startTime = warData.war.start;
            const endTime = warData.war.end;
            
            if (endTime > 0) {
                return 'Finished';
            } else if (now < startTime) {
                return 'Upcoming';
            } else {
                return 'Active';
            }
        }

        // Refresh live war data from API
        async function refreshLiveWarData() {
            try {
                console.log('Fetching live war data for user bets...');
                
                // Fetch current war data from Torn API
                const response = await fetch('/api/torn/rankedwars?key=C0wctKtdsgjJYpWe');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Store the live data for use in bet cards
                if (data.rankedwars) {
                    localStorage.setItem('liveWarData', JSON.stringify({
                        data: data.rankedwars,
                        timestamp: Date.now()
                    }));
                    console.log('Live war data updated successfully');
                }
            } catch (error) {
                console.error('Error fetching live war data:', error);
            }
        }

        // Get live scores for the war
        function getLiveScores(warData, userFactionId) {
            if (!warData || !warData.factions) {
                return '<div class="user-bet-scores">ðŸ”„ Fetching live data...</div>';
            }
            
            const factions = Object.entries(warData.factions);
            if (factions.length !== 2) {
                return '<div class="user-bet-scores">Invalid war data</div>';
            }
            
            const [faction1Id, faction1Data] = factions[0];
            const [faction2Id, faction2Data] = factions[1];
            
            const isUserFaction1 = faction1Id === userFactionId.toString();
            const userFaction = isUserFaction1 ? faction1Data : faction2Data;
            const opponentFaction = isUserFaction1 ? faction2Data : faction1Data;
            
            const userScore = userFaction.score || 0;
            const opponentScore = opponentFaction.score || 0;
            const target = warData.war.target || 0;
            
            // Calculate lead percentages (target is the lead difference)
            const scoreDifference = Math.abs(userScore - opponentScore);
            const userLead = userScore > opponentScore ? scoreDifference : 0;
            const opponentLead = opponentScore > userScore ? scoreDifference : 0;
            
            const userProgress = target > 0 ? Math.min((userLead / target) * 100, 100) : 0;
            const opponentProgress = target > 0 ? Math.min((opponentLead / target) * 100, 100) : 0;
            
            return `
                <div class="user-bet-scores">
                    <div class="user-bet-score-row">
                        <div class="user-bet-score-faction user-faction">
                            <span class="user-bet-score-name">${userFaction.name}</span>
                            <span class="user-bet-score-value">${userScore.toLocaleString()}</span>
                        </div>
                        <div class="user-bet-score-progress">
                            <div class="user-bet-progress-bar">
                                <div class="user-bet-progress-fill" style="width: ${userProgress}%; background: #059669;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-bet-score-row">
                        <div class="user-bet-score-faction opponent-faction">
                            <span class="user-bet-score-name">${opponentFaction.name}</span>
                            <span class="user-bet-score-value">${opponentScore.toLocaleString()}</span>
                        </div>
                        <div class="user-bet-score-progress">
                            <div class="user-bet-progress-bar">
                                <div class="user-bet-progress-fill" style="width: ${opponentProgress}%; background: #dc2626;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="user-bet-target">
                        <span class="user-bet-target-label">Lead Target:</span>
                        <span class="user-bet-target-value">${target.toLocaleString()}</span>
                    </div>
                    
                    <div class="user-bet-lead-info">
                        <span class="user-bet-lead-info-text">${userLead > 0 ? `Your faction leads by ${userLead.toLocaleString()}` : opponentLead > 0 ? `Opponent leads by ${opponentLead.toLocaleString()}` : 'Scores are tied'}</span>
                    </div>
                    
                    <div class="user-bet-live-timestamp">
                        <span class="user-bet-live-timestamp-text">ðŸ”„ Live data updated: ${new Date().toLocaleTimeString()}</span>
                    </div>
                </div>
            `;
        }

        // Show user notification
        function showUserNotification(title, message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #059669, #047857);
                color: white;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 350px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 8px;">${title}</div>
                <div style="font-size: 0.9rem;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function fetchFactionRespectData(uniqueFactionIds) {
            console.log('Fetching enhanced faction data for', uniqueFactionIds.size, 'factions...');
            
            // Initialize enhanced data object
            const factionEnhancedData = {};
            
            // Load local faction data
            let localFactionData = {};
            try {
                console.log('Loading local faction data...');
                const localResponse = await fetch('/data/factions.json');
                const localResult = await localResponse.json();
                
                if (localResult.factions) {
                    // Convert array to object for easier lookup
                    localFactionData = localResult.factions.reduce((acc, faction) => {
                        acc[faction.id] = faction;
                        return acc;
                    }, {});
                    console.log(`Loaded ${Object.keys(localFactionData).length} factions from local data`);
                } else {
                    console.warn('Failed to load local faction data');
                }
            } catch (error) {
                console.warn('Error loading local faction data:', error);
            }
            
            // Use only local data to avoid rate limiting
            Array.from(uniqueFactionIds).forEach((factionId) => {
                const localData = localFactionData[factionId] || {};
                
                factionEnhancedData[factionId] = {
                    chain: 0, // Default to 0 to avoid API calls
                    respect: localData.respect || null,
                    rank: localData.rank || null,
                    members: localData.members || null,
                    position: localData.position || null
                };
            });
            
            console.log('Fetched enhanced faction data from local data:', factionEnhancedData);
            console.log('Total factions with enhanced data:', Object.keys(factionEnhancedData).length);
            console.log('Sample enhanced data:', Object.entries(factionEnhancedData).slice(0, 3));
            
            // Log factions with respect data
            const factionsWithRespect = Object.entries(factionEnhancedData)
                .filter(([id, data]) => data.respect !== null)
                .length;
            console.log(`Factions with respect data: ${factionsWithRespect}/${Object.keys(factionEnhancedData).length}`);
            
            return factionEnhancedData;
        }

        // Bet Tracking Functions
        let allBets = [];
        let filteredBets = [];
        let betTrackingActive = false;

        // Toggle bet tracking section
        function toggleBetTracking() {
            const content = document.getElementById('bet-tracking-content');
            const toggle = document.querySelector('.bet-tracking-toggle');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                toggle.textContent = 'ðŸ“Š Show Tracking';
                betTrackingActive = false;
            } else {
                content.classList.add('active');
                toggle.textContent = 'ðŸ“Š Hide Tracking';
                betTrackingActive = true;
                loadBetData();
            }
        }

        // Load bet data
        async function loadBetData() {
            try {
                // Get bets from localStorage (shared with betting interface)
                const storedBets = localStorage.getItem('tornBets');
                if (storedBets) {
                    allBets = JSON.parse(storedBets);
                } else {
                    allBets = [];
                }
                
                filteredBets = [...allBets];
                updateBetStats();
                updateBetTable();
                updateBetFilters();
                
            } catch (error) {
                console.error('Error loading bet data:', error);
            }
        }

        // Update bet statistics
        function updateBetStats() {
            const stats = {
                total: allBets.length,
                totalVolume: allBets.reduce((sum, bet) => sum + bet.betAmount, 0),
                active: allBets.filter(bet => bet.status === 'confirmed').length,
                pending: allBets.filter(bet => bet.status === 'pending').length,
                won: allBets.filter(bet => bet.status === 'won').length,
                lost: allBets.filter(bet => bet.status === 'lost').length,
                totalPayouts: allBets.filter(bet => bet.status === 'won').reduce((sum, bet) => sum + calculatePayoutAmount(bet), 0),
                totalProfit: allBets.filter(bet => bet.status === 'won').reduce((sum, bet) => sum + calculatePayoutAmount(bet), 0) - 
                            allBets.filter(bet => bet.status === 'lost').reduce((sum, bet) => sum + bet.betAmount, 0)
            };

            document.getElementById('total-bets').textContent = stats.total;
            document.getElementById('total-volume').textContent = `$${(stats.totalVolume / 1000000).toFixed(1)}M`;
            document.getElementById('active-bets').textContent = stats.active;
            document.getElementById('won-bets').textContent = stats.won;
            document.getElementById('lost-bets').textContent = stats.lost;
            document.getElementById('total-payouts').textContent = `$${(stats.totalPayouts / 1000000).toFixed(1)}M`;
            document.getElementById('total-profit').textContent = `$${(stats.totalProfit / 1000000).toFixed(1)}M`;
        }

        // Update bet table
        function updateBetTable() {
            const tbody = document.getElementById('bet-table-body');
            
            if (filteredBets.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #64748b;">
                            <div style="font-size: 1.1rem; margin-bottom: 8px;">ðŸ“Š No bets found</div>
                            <div style="font-size: 0.9rem;">Place some bets to see them here!</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredBets.map(bet => {
                const payoutAmount = calculatePayoutAmount(bet);
                const profit = bet.status === 'won' ? payoutAmount - bet.betAmount : 
                              bet.status === 'lost' ? -bet.betAmount : 0;
                const betMessage = generateBetMessage(bet);
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: #1e293b;">${bet.playerId}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">ID: ${bet.playerId}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #1e293b;">War ${bet.warId}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">${formatTimestamp(bet.timePlaced)}</div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #1e293b;">Faction ${bet.factionId}</div>
                            <div style="font-size: 0.75rem; color: #64748b;">${bet.xanaxAmount} Xanax</div>
                        </td>
                        <td>
                            <div class="bet-amount">$${(bet.betAmount / 1000000).toFixed(1)}M</div>
                        </td>
                        <td>
                            <div style="font-size: 0.8rem; color: #64748b;">${formatTimestamp(bet.timePlaced)}</div>
                        </td>
                        <td>
                            <span class="bet-status-badge bet-status-${bet.status}">${bet.status}</span>
                        </td>
                        <td>
                            <div class="bet-payout">${bet.status === 'won' ? `$${(payoutAmount / 1000000).toFixed(1)}M` : '-'}</div>
                        </td>
                        <td>
                            <div class="bet-profit ${profit > 0 ? 'positive' : profit < 0 ? 'negative' : 'neutral'}">
                                ${profit > 0 ? '+' : ''}$${(profit / 1000000).toFixed(1)}M
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="font-family: 'DM Sans', monospace; font-size: 0.8rem; color: #374151; background: #f8fafc; padding: 4px 8px; border-radius: 4px; border: 1px solid #e2e8f0; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${betMessage}">${betMessage}</div>
                                <button class="bet-action-btn view" onclick="copyBetMessage('${bet.betId}')" title="Copy Bet Message">ðŸ“‹</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update bet filters
        function updateBetFilters() {
            const warFilter = document.getElementById('bet-war-filter');
            const uniqueWars = [...new Set(allBets.map(bet => bet.warId))];
            
            warFilter.innerHTML = '<option value="">All Wars</option>' + 
                uniqueWars.map(warId => `<option value="${warId}">War ${warId}</option>`).join('');
        }

        // Clear bet filters
        function clearBetFilters() {
            document.getElementById('bet-status-filter').value = '';
            document.getElementById('bet-war-filter').value = '';
            filteredBets = [...allBets];
            updateBetTable();
        }

        // Copy bet message to clipboard
        function copyBetMessage(betId) {
            const bet = allBets.find(b => b.betId === betId);
            if (!bet) return;
            
            const betMessage = generateBetMessage(bet);
            
            // Copy to clipboard
            navigator.clipboard.writeText(betMessage).then(() => {
                showUserNotification('Bet Message Copied', 'Bet message has been copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy bet message:', err);
                // Fallback: show the message in an alert
                alert(`Bet Message:\n${betMessage}\n\nCopy this message manually.`);
            });
        }

        // Set up bet filter event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing API key on page load
            checkExistingApiKey();
            
            // Add event listeners for bet filters
            const statusFilter = document.getElementById('bet-status-filter');
            const warFilter = document.getElementById('bet-war-filter');
            
            if (statusFilter) {
                statusFilter.addEventListener('change', filterBets);
            }
            if (warFilter) {
                warFilter.addEventListener('change', filterBets);
            }
        });

        // Filter bets based on current filters
        function filterBets() {
            const statusFilter = document.getElementById('bet-status-filter')?.value;
            const warFilter = document.getElementById('bet-war-filter')?.value;
            
            filteredBets = allBets.filter(bet => {
                const statusMatch = !statusFilter || bet.status === statusFilter;
                const warMatch = !warFilter || bet.warId === warFilter;
                
                return statusMatch && warMatch;
            });
            
            updateBetTable();
        }
    </script>
</body>
</html> 